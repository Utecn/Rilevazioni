<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel ¬∑ Rilevazioni</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#060608;--panel:#0d0d12;--card:#111118;--card2:#16161f;
  --border:#1e1e2e;--border2:#2a2a3e;--text:#c8c8d8;--dim:#4a4a6a;
  --orange:#ff5500;--orange-dim:rgba(255,85,0,0.15);
  --cyan:#00e5ff;--green:#00ff88;--purple:#b388ff;--red:#ff3355;
  --sidebar-w:220px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading-screen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
.loading-screen.hidden{display:none;}
.loader{width:36px;height:36px;border:3px solid var(--border2);border-top-color:var(--orange);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--dim);letter-spacing:2px;}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.login-screen{position:fixed;inset:0;z-index:800;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:24px;}
.login-screen.hidden{display:none;}
.login-box{width:100%;max-width:340px;display:flex;flex-direction:column;align-items:center;}
.login-logo{font-size:13px;font-weight:700;letter-spacing:5px;color:var(--dim);text-transform:uppercase;margin-bottom:36px;font-family:'Share Tech Mono',monospace;}
.login-logo span{color:var(--orange);}
.login-title{font-size:24px;font-weight:700;margin-bottom:4px;}
.login-sub{font-size:12px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-bottom:28px;letter-spacing:1px;}
.login-field{width:100%;margin-bottom:12px;}
.login-label{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;display:block;margin-bottom:6px;font-family:'Share Tech Mono',monospace;}
.login-input{width:100%;padding:13px 14px;background:var(--card);border:1px solid var(--border2);border-radius:8px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:600;outline:none;transition:border-color .15s;}
.login-input:focus{border-color:var(--orange);}
.login-btn{width:100%;padding:14px;background:var(--orange);border:none;border-radius:8px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-top:6px;box-shadow:0 0 24px rgba(255,85,0,.3);}
.login-btn:hover{opacity:.9;}
.login-error{color:var(--red);font-size:12px;font-family:'Share Tech Mono',monospace;text-align:center;margin-top:10px;min-height:18px;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{display:none;height:100vh;overflow:hidden;}
.app.show{display:flex;}

/* SIDEBAR (desktop) */
.sidebar{width:var(--sidebar-w);flex-shrink:0;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;overflow:hidden;}
.sidebar-logo{padding:20px 18px 14px;border-bottom:1px solid var(--border);}
.sidebar-logo-text{font-family:'Share Tech Mono',monospace;font-size:13px;font-weight:700;letter-spacing:4px;color:var(--dim);}
.sidebar-logo-text span{color:var(--orange);}
.sidebar-logo-sub{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;letter-spacing:1px;margin-top:4px;}
.sidebar-user{padding:12px 18px;border-bottom:1px solid var(--border);}
.sidebar-user-name{font-size:13px;font-weight:700;color:var(--purple);}
.sidebar-user-role{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:2px;}
.sidebar-nav{flex:1;overflow-y:auto;padding:10px 0;}
.nav-item{display:flex;align-items:center;gap:10px;padding:11px 18px;cursor:pointer;font-size:13px;font-weight:700;letter-spacing:.5px;color:var(--dim);transition:color .15s,background .15s;border-left:3px solid transparent;}
.nav-item:hover{color:var(--text);background:var(--card2);}
.nav-item.active{color:var(--purple);background:rgba(179,136,255,.06);border-left-color:var(--purple);}
.nav-item-icon{font-size:16px;width:20px;text-align:center;}
.sidebar-footer{padding:14px 18px;border-top:1px solid var(--border);}
.logout-btn{width:100%;padding:9px;background:transparent;border:1px solid var(--border2);border-radius:6px;color:var(--dim);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:1px;}
.logout-btn:hover{border-color:var(--red);color:var(--red);}
.app-link{width:100%;padding:9px;background:var(--orange);border:none;border-radius:6px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:1px;margin-bottom:8px;text-align:center;display:block;text-decoration:none;}
.app-link:hover{opacity:.85;}

/* MAIN CONTENT */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.main-header{flex-shrink:0;display:flex;align-items:center;gap:12px;padding:12px 20px;background:var(--panel);border-bottom:1px solid var(--border);}
.main-header-title{font-size:16px;font-weight:700;letter-spacing:2px;text-transform:uppercase;}
.main-header-title span{color:var(--purple);}
.main-body{flex:1;overflow-y:auto;padding:20px;}

/* MOBILE BOTTOM NAV */
.mobile-nav{display:none;flex-shrink:0;background:var(--panel);border-top:1px solid var(--border);}
.mobile-nav-item{flex:1;padding:10px 4px;text-align:center;font-size:11px;font-weight:700;letter-spacing:.5px;color:var(--dim);cursor:pointer;border-top:2px solid transparent;text-transform:uppercase;}
.mobile-nav-item.active{color:var(--purple);border-top-color:var(--purple);}
.mobile-nav-icon{font-size:18px;display:block;margin-bottom:2px;}
.mobile-top-bar{display:none;flex-shrink:0;align-items:center;padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border);gap:10px;}
.mobile-top-bar-title{flex:1;font-size:14px;font-weight:700;letter-spacing:1px;text-transform:uppercase;}
.mobile-top-bar-title span{color:var(--purple);}

@media(max-width:700px){
  .sidebar{display:none;}
  .mobile-nav{display:flex;}
  .mobile-top-bar{display:flex;}
  .main-header{display:none;}
  .main-body{padding:12px;}
}

/* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
.section{display:none;}
.section.active{display:block;}

/* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
.page-title{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:16px;font-family:'Share Tech Mono',monospace;}
.add-form{background:var(--card2);border:1px solid var(--border2);border-radius:10px;padding:18px;margin-bottom:20px;}
.add-form-title{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:14px;font-family:'Share Tech Mono',monospace;}
.form-row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
.form-input{flex:1;min-width:140px;padding:10px 12px;background:var(--card);border:1px solid var(--border2);border-radius:6px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;outline:none;}
.form-input:focus{border-color:var(--orange);}
.form-select{flex:1;min-width:120px;padding:10px 12px;background:var(--card);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;outline:none;}
.form-select:focus{border-color:var(--orange);}
.form-submit{padding:11px 20px;background:var(--orange);border:none;border-radius:6px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:1.5px;cursor:pointer;}
.form-submit:hover{opacity:.85;}
.form-submit.purple{background:var(--purple);color:#000;}
.form-submit.full{width:100%;}

/* ‚îÄ‚îÄ DESKTOP 2-COL LAYOUT ‚îÄ‚îÄ */
.two-col{display:grid;grid-template-columns:340px 1fr;gap:20px;align-items:start;}
@media(max-width:1000px){.two-col{grid-template-columns:1fr;}}

/* ‚îÄ‚îÄ CARDS LIST ‚îÄ‚îÄ */
.admin-card{background:var(--card);border:1px solid var(--border2);border-radius:10px;margin-bottom:10px;overflow:hidden;}
.admin-card-header{display:flex;align-items:center;padding:13px 16px;gap:12px;cursor:pointer;transition:background .15s;}
.admin-card-header:hover{background:var(--card2);}
.admin-card-info{flex:1;}
.admin-card-name{font-size:14px;font-weight:700;}
.admin-card-meta{font-size:11px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:3px;}
.role-badge{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:1px;font-family:'Share Tech Mono',monospace;}
.role-badge.admin{background:rgba(179,136,255,.2);color:var(--purple);border:1px solid var(--purple);}
.role-badge.operatore{background:rgba(0,229,255,.1);color:var(--cyan);border:1px solid var(--cyan);}
.role-badge.project_manager{background:rgba(255,85,0,.15);color:var(--orange);border:1px solid var(--orange);}
.chevron{color:var(--dim);font-size:12px;transition:transform .2s;}
.admin-card.open .chevron{transform:rotate(180deg);}
.user-body{display:none;padding:16px;border-top:1px solid var(--border);background:var(--card2);}
.admin-card.open .user-body{display:block;}
.user-fields{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.user-input{flex:1;min-width:140px;padding:9px 12px;background:var(--bg);border:1px solid var(--border2);border-radius:6px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;outline:none;}
.user-input:focus{border-color:var(--orange);}
.user-select{flex:1;min-width:120px;padding:9px 12px;background:var(--bg);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;outline:none;}
.user-actions{display:flex;gap:8px;flex-wrap:wrap;}
.ubtn{padding:8px 12px;background:var(--card);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:.5px;white-space:nowrap;}
.ubtn:hover{opacity:.8;}
.ubtn.save{border-color:var(--orange);color:var(--orange);}
.ubtn.off{border-color:var(--cyan);color:var(--cyan);}
.ubtn.on{border-color:var(--green);color:var(--green);}
.ubtn.del{border-color:var(--red);color:var(--red);}

/* projects */
.proj-admin-card{background:var(--card);border:1px solid var(--border2);border-radius:10px;margin-bottom:10px;overflow:hidden;}
.proj-admin-header{display:flex;align-items:flex-start;padding:13px 16px;gap:12px;cursor:pointer;transition:background .15s;}
.proj-admin-header:hover{background:var(--card2);}
.proj-admin-name{font-size:14px;font-weight:700;flex:1;}
.proj-admin-meta{font-size:11px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:2px;}
.proj-admin-body{display:none;padding:16px;border-top:1px solid var(--border);}
.proj-admin-card.open .proj-admin-body{display:block;}
.members-title{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin:14px 0 8px;font-family:'Share Tech Mono',monospace;}
.members-title:first-child{margin-top:0;}
.member-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.member-row:last-child{border-bottom:none;}
.member-name{flex:1;font-size:13px;font-weight:600;}
.member-remove{background:transparent;border:1px solid var(--red);color:var(--red);padding:4px 10px;border-radius:4px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Rajdhani',sans-serif;}
.member-remove:hover{background:var(--red);color:#fff;}
.add-member-wrap{display:flex;gap:8px;margin-top:10px;}
.member-select{flex:1;padding:8px 10px;background:var(--card2);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;outline:none;}
.add-member-btn{padding:8px 14px;background:var(--green);border:none;color:#000;border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;}
.add-member-btn:hover{opacity:.85;}
.proj-admin-actions{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;}
.proj-action-btn{padding:8px 14px;background:var(--card2);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;}
.proj-action-btn:hover{opacity:.8;}
.proj-action-btn.del{border-color:var(--red);color:var(--red);}

/* anagrafiche */
.ana-section{background:var(--card);border:1px solid var(--border2);border-radius:10px;margin-bottom:10px;overflow:hidden;}
.ana-section-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;background:var(--card2);transition:background .15s;}
.ana-section-header:hover{background:var(--border);}
.ana-section-title{font-size:12px;font-weight:700;letter-spacing:1.5px;color:var(--text);text-transform:uppercase;}
.ana-section-count{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;}
.ana-section-body{display:none;padding:14px 16px 16px;}
.ana-section.open .ana-section-body{display:block;}
.ana-tag{display:inline-flex;align-items:center;gap:5px;background:var(--card2);border:1px solid var(--border2);border-radius:4px;padding:4px 9px;font-size:12px;font-weight:600;margin:3px;cursor:default;}
.ana-tag-del{color:var(--red);cursor:pointer;font-size:13px;padding:0 2px;}
.ana-tag-del:hover{opacity:.7;}
.ana-new-input{flex:1;padding:8px 10px;background:var(--bg);border:1px solid var(--border2);border-radius:6px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;outline:none;text-transform:uppercase;}
.ana-new-input:focus{border-color:var(--purple);}
.ana-save-btn{padding:0 12px;height:34px;background:var(--purple);border:none;color:#000;border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;}
.ana-save-btn:hover{opacity:.85;}
.ana-cancel-btn{flex-shrink:0;background:var(--card);border:1px solid var(--border2);color:var(--dim);padding:0 10px;height:34px;border-radius:6px;font-size:13px;cursor:pointer;}

/* backup */
.backup-filter-row{display:flex;gap:8px;margin-bottom:14px;}
.backup-filter-select{padding:8px 10px;background:var(--card2);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;outline:none;}
.backup-type-tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
.backup-type-btn{flex:1;min-width:120px;padding:9px 10px;background:var(--card2);border:1px solid var(--border2);border-radius:6px;color:var(--dim);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;text-align:center;letter-spacing:.5px;}
.backup-type-btn:hover{color:var(--text);}
.backup-type-btn.active{border-color:var(--orange);color:var(--orange);}
.backup-row{display:flex;align-items:flex-start;gap:12px;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:12px 14px;margin-bottom:8px;}
.backup-row.deleted{border-color:rgba(255,51,85,.4);background:rgba(255,51,85,.04);}
.backup-row.updated{border-color:rgba(0,229,255,.25);}
.backup-row-info{flex:1;min-width:0;}
.backup-row-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.backup-row-meta{font-size:11px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:3px;line-height:1.6;}
.backup-action-badge{font-size:9px;font-weight:700;letter-spacing:1px;font-family:'Share Tech Mono',monospace;padding:3px 7px;border-radius:4px;flex-shrink:0;white-space:nowrap;}
.badge-DELETE{background:rgba(255,51,85,.2);color:var(--red);border:1px solid var(--red);}
.badge-UPDATE{background:rgba(0,229,255,.1);color:var(--cyan);border:1px solid var(--cyan);}
.badge-INSERT{background:rgba(0,255,136,.1);color:var(--green);border:1px solid var(--green);}
.restore-btn{flex-shrink:0;padding:7px 12px;background:transparent;border:1px solid var(--orange);color:var(--orange);border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;}
.restore-btn:hover{background:var(--orange);color:#fff;}
.backup-empty{padding:40px 20px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--dim);line-height:2;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--card2);border:1px solid var(--border2);color:var(--text);padding:9px 20px;border-radius:30px;font-family:'Share Tech Mono',monospace;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;z-index:3000;transition:opacity .2s,transform .2s;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ‚îÄ‚îÄ EMPTY / STATUS ‚îÄ‚îÄ */
.empty-msg{padding:40px 20px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--dim);line-height:2;}
.section-count{font-size:11px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-bottom:12px;}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="loader"></div>
  <div class="loading-text" id="loadingText">CONNESSIONE...</div>
</div>

<!-- LOGIN -->
<div class="login-screen hidden" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">RILE<span>V</span>AZIONI</div>
    <div class="login-title">Pannello Admin</div>
    <div class="login-sub">accesso riservato agli amministratori</div>
    <div class="login-field">
      <label class="login-label">Email</label>
      <input class="login-input" id="loginEmail" type="email" autocomplete="email" placeholder="nome@azienda.com">
    </div>
    <div class="login-field">
      <label class="login-label">Password</label>
      <input class="login-input" id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="login-btn" onclick="doLogin()">ACCEDI</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app">

  <!-- SIDEBAR (desktop) -->
  <div class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-text">RILE<span>V</span>AZIONI</div>
      <div class="sidebar-logo-sub">PANNELLO ADMIN</div>
    </div>
    <div class="sidebar-user">
      <div class="sidebar-user-name" id="sidebarUserName">‚Äî</div>
      <div class="sidebar-user-role">Amministratore</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="switchSection('users')" id="nav-users">
        <span class="nav-item-icon">üë•</span> Utenti
      </div>
      <div class="nav-item" onclick="switchSection('projects')" id="nav-projects">
        <span class="nav-item-icon">üìÅ</span> Progetti
      </div>
      <div class="nav-item" onclick="switchSection('anagrafiche')" id="nav-anagrafiche">
        <span class="nav-item-icon">üóÇ</span> Anagrafiche
      </div>
      <div class="nav-item" onclick="switchSection('backup')" id="nav-backup">
        <span class="nav-item-icon">üóÑ</span> Backup
      </div>
    </nav>
    <div class="sidebar-footer">
      <a class="app-link" id="backAppLink" href="#">‚Üê Torna all'App</a>
      <button class="logout-btn" onclick="doLogout()">‚èª Esci</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- Mobile top bar -->
    <div class="mobile-top-bar">
      <a id="backAppLinkMobile" href="#" style="background:transparent;border:1px solid var(--border2);color:var(--dim);padding:5px 9px;border-radius:6px;font-size:12px;text-decoration:none;font-family:'Rajdhani',sans-serif;font-weight:700;">‚Üê App</a>
      <div class="mobile-top-bar-title">RILE<span>V</span>AZIONI ¬∑ <span style="color:var(--dim);font-weight:400;font-size:12px;letter-spacing:1px;">ADMIN</span></div>
      <span id="mobileUserName" style="font-size:11px;color:var(--purple);font-family:'Share Tech Mono',monospace;"></span>
      <button onclick="doLogout()" style="background:transparent;border:1px solid var(--border2);color:var(--dim);padding:5px 9px;border-radius:6px;font-size:12px;cursor:pointer;">‚èª</button>
    </div>

    <!-- Desktop header -->
    <div class="main-header">
      <div class="main-header-title">PANNELLO <span>AMMINISTRAZIONE</span></div>
      <div id="mainHeaderSub" style="font-size:11px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-left:auto;"></div>
    </div>

    <div class="main-body">

      <!-- ‚îÄ‚îÄ UTENTI ‚îÄ‚îÄ -->
      <div class="section active" id="sectionUsers">
        <div class="two-col">
          <div>
            <div class="add-form">
              <div class="add-form-title">NUOVO UTENTE</div>
              <div class="form-row">
                <input class="form-input" id="uName" placeholder="Nome completo" type="text">
                <input class="form-input" id="uEmail" placeholder="Email" type="email">
              </div>
              <div class="form-row">
                <input class="form-input" id="uPass" placeholder="Password (min 6 car.)" type="password">
                <select class="form-select" id="uRole">
                  <option value="operatore">Operatore</option>
                  <option value="project_manager">Project Manager</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <button class="form-submit full" onclick="createUser()">Ôºã CREA UTENTE</button>
            </div>
          </div>
          <div>
            <div id="userListHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div class="page-title" style="margin:0;">UTENTI REGISTRATI</div>
              <button onclick="toggleHidden()" id="toggleHiddenBtn" style="background:var(--card2);border:1px solid var(--border2);color:var(--dim);padding:6px 12px;border-radius:6px;font-family:Rajdhani,sans-serif;font-size:11px;font-weight:700;cursor:pointer;display:none;">üëÅ ARCHIVIATI</button>
            </div>
            <div id="userList"></div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ PROGETTI ‚îÄ‚îÄ -->
      <div class="section" id="sectionProjects">
        <div class="two-col">
          <div>
            <div class="add-form">
              <div class="add-form-title">NUOVO PROGETTO</div>
              <select class="form-select" id="pContract" style="width:100%;margin-bottom:10px;"><option value="">‚Äî Seleziona Appalto ‚Äî</option></select>
              <input class="form-input" id="pName" placeholder="Nome progetto" type="text" style="width:100%;margin-bottom:10px;">
              <button class="form-submit purple full" onclick="adminCreateProject()">Ôºã CREA PROGETTO</button>
            </div>
          </div>
          <div>
            <div class="page-title">TUTTI I PROGETTI</div>
            <div id="projectAdminList"></div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ ANAGRAFICHE ‚îÄ‚îÄ -->
      <div class="section" id="sectionAnagrafiche">
        <div class="page-title">ANAGRAFICHE DI SISTEMA</div>
        <div id="anagraficheList"></div>
      </div>

      <!-- ‚îÄ‚îÄ BACKUP ‚îÄ‚îÄ -->
      <div class="section" id="sectionBackup">
        <div class="page-title">ARCHIVIO MODIFICHE</div>
        <div class="backup-type-tabs">
          <div class="backup-type-btn active" id="bbtContracts" onclick="switchBackupType('contracts')">üìã APPALTI</div>
          <div class="backup-type-btn" id="bbtProjects" onclick="switchBackupType('projects')">üìÅ PROGETTI</div>
          <div class="backup-type-btn" id="bbtLog" onclick="switchBackupType('log_entries')">‚è± RILEVAZIONI</div>
        </div>
        <div class="backup-filter-row">
          <select class="backup-filter-select" id="backupActionFilter" onchange="renderBackupList()">
            <option value="">Tutte le azioni</option>
            <option value="DELETE">Solo eliminati</option>
            <option value="UPDATE">Solo modificati</option>
            <option value="INSERT">Solo creati</option>
          </select>
        </div>
        <div id="backupList"><div class="backup-empty">Seleziona una categoria qui sopra.</div></div>
      </div>

    </div><!-- /main-body -->

    <!-- Mobile bottom nav -->
    <div class="mobile-nav">
      <div class="mobile-nav-item active" onclick="switchSection('users')" id="mnav-users">
        <span class="mobile-nav-icon">üë•</span>UTENTI
      </div>
      <div class="mobile-nav-item" onclick="switchSection('projects')" id="mnav-projects">
        <span class="mobile-nav-icon">üìÅ</span>PROGETTI
      </div>
      <div class="mobile-nav-item" onclick="switchSection('anagrafiche')" id="mnav-anagrafiche">
        <span class="mobile-nav-icon">üóÇ</span>ANAGRAFI
      </div>
      <div class="mobile-nav-item" onclick="switchSection('backup')" id="mnav-backup">
        <span class="mobile-nav-icon">üóÑ</span>BACKUP
      </div>
    </div>
  </div><!-- /main -->
</div><!-- /app -->

<div class="toast" id="toast"></div>

<script>
// Rileva dispositivo e imposta target
const _isMobile = window.innerWidth < 768 || /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
const _appTarget = _isMobile ? 'index_mobile.html' : 'index_desktop.html';

// Funzione torna all'app: chiude connessioni Supabase prima di navigare
async function goBackToApp(){
  try {
    await sb.removeAllChannels();
    await sb.auth.stopAutoRefresh();
  } catch(e){ /* ignora */ }
  setTimeout(() => { window.location.href = _appTarget; }, 80);
}

(function setBackLink(){
  const label     = _isMobile ? '‚Üê App Mobile' : '‚Üê App Desktop';
  const labelMob  = _isMobile ? '‚Üê App' : '‚Üê Desktop';
  const el  = document.getElementById('backAppLink');
  const elm = document.getElementById('backAppLinkMobile');
  el.href  = '#'; el.textContent  = label;  el.onclick = e=>{ e.preventDefault(); goBackToApp(); };
  elm.href = '#'; elm.textContent = labelMob; elm.onclick = e=>{ e.preventDefault(); goBackToApp(); };
})();

const SUPABASE_URL  = 'https://bjirlbcnymwibtfjovce.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqaXJsYmNueW13aWJ0ZmpvdmNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDM3ODUsImV4cCI6MjA4NzA3OTc4NX0.mDwGbTvdPxtY6gUqWus3WvrSyxy4IZdTCMurqZyhww4';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);
const sbAdmin = createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { autoRefreshToken: false, persistSession: false, storageKey: 'sb-admin-auth' }
});

let currentUser = null;
let _showHidden = false;
let _backupType = 'contracts';
let _backupData = [];

function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ‚îÄ‚îÄ TOAST / LOADING ‚îÄ‚îÄ */
let toastT = null;
function toast(msg){
  const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show');
  clearTimeout(toastT); toastT = setTimeout(()=>el.classList.remove('show'), 2800);
}
function showLoading(txt){
  document.getElementById('loadingText').textContent = txt||'CARICAMENTO...';
  document.getElementById('loadingScreen').classList.remove('hidden');
}
function hideLoading(){ document.getElementById('loadingScreen').classList.add('hidden'); }

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
async function doLogin(){
  const email = document.getElementById('loginEmail').value.trim();
  const pass   = document.getElementById('loginPassword').value;
  document.getElementById('loginError').textContent = '';
  if(!email||!pass){ document.getElementById('loginError').textContent='Inserisci email e password'; return; }
  showLoading('ACCESSO...');
  try {
    const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
    if(error) throw error;
    const { data: prof } = await sb.from('profiles').select('name,role,active').eq('id', data.user.id).single();
    if(!prof?.active){ await sb.auth.signOut(); throw new Error('Account disattivato'); }
    if(prof.role !== 'admin'){ await sb.auth.signOut(); throw new Error('Accesso riservato agli amministratori'); }
    currentUser = { id: data.user.id, email: data.user.email, name: prof.name, role: prof.role };
    hideLoading();
    afterLogin();
  } catch(e){
    hideLoading();
    document.getElementById('loginError').textContent = e.message === 'Invalid login credentials' ? 'Credenziali non valide' : e.message;
  }
}
document.getElementById('loginEmail').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('loginPassword').focus(); });
document.getElementById('loginPassword').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

async function doLogout(){
  await sb.auth.signOut();
  currentUser = null;
  document.getElementById('app').classList.remove('show');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('loginPassword').value = '';
}

function afterLogin(){
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('app').classList.add('show');
  document.getElementById('sidebarUserName').textContent = currentUser.name;
  document.getElementById('mobileUserName').textContent  = currentUser.name;
  document.getElementById('mainHeaderSub').textContent   = currentUser.name;
  loadAdminData();
}

/* ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ */
let _currentSection = 'users';
function switchSection(sec){
  _currentSection = sec;
  ['users','projects','anagrafiche','backup'].forEach(s=>{
    document.getElementById('sectionUsers'.replace('users',s.charAt(0).toUpperCase()+s.slice(1))||'section'+s.charAt(0).toUpperCase()+s.slice(1))?.classList.toggle('active', s===sec);
    document.getElementById('nav-'+s)?.classList.toggle('active', s===sec);
    document.getElementById('mnav-'+s)?.classList.toggle('active', s===sec);
  });
  // Fix IDs
  document.getElementById('sectionUsers').classList.toggle('active', sec==='users');
  document.getElementById('sectionProjects').classList.toggle('active', sec==='projects');
  document.getElementById('sectionAnagrafiche').classList.toggle('active', sec==='anagrafiche');
  document.getElementById('sectionBackup').classList.toggle('active', sec==='backup');
  ['users','projects','anagrafiche','backup'].forEach(s=>{
    document.getElementById('nav-'+s)?.classList.toggle('active',s===sec);
    document.getElementById('mnav-'+s)?.classList.toggle('active',s===sec);
  });
  if(sec==='anagrafiche' && !document.getElementById('anagraficheList').children.length) loadAnagraficheAdmin();
  if(sec==='backup') fetchAndRenderBackup();
}

async function loadAdminData(){
  showLoading('CARICAMENTO...');
  await Promise.all([loadUserList(), loadProjectAdminList(), loadContractSelect()]);
  hideLoading();
}

/* ‚îÄ‚îÄ UTENTI ‚îÄ‚îÄ */
async function loadContractSelect(){
  const {data:contracts} = await sb.from('contracts').select('id,name').order('name');
  const sel = document.getElementById('pContract');
  sel.innerHTML = '<option value="">‚Äî Seleziona Appalto ‚Äî</option>' +
    (contracts||[]).map(c=>'<option value="'+c.id+'">'+esc(c.name)+'</option>').join('');
}

function toggleHidden(){ _showHidden = !_showHidden; loadUserList(); }

async function loadUserList(){
  const { data: profiles } = await sb.from('profiles').select('id,name,email,role,active,hidden').order('name');
  const list = document.getElementById('userList'); list.innerHTML = '';
  const hiddenCount = (profiles||[]).filter(u=>u.hidden && u.id!==currentUser.id).length;
  const btn = document.getElementById('toggleHiddenBtn');
  if(hiddenCount > 0){
    btn.style.display = '';
    btn.textContent = _showHidden ? 'üëÅ NASCONDI ARCHIVIATI' : 'üëÅ ARCHIVIATI ('+hiddenCount+')';
  } else { btn.style.display = 'none'; }
  const visible = (profiles||[]).filter(u => _showHidden ? true : !u.hidden);
  if(!visible.length){ list.innerHTML='<div class="empty-msg">Nessun utente.</div>'; return; }
  visible.forEach(u=>{
    const isSelf = u.id === currentUser.id;
    const card = document.createElement('div'); card.className = 'admin-card';
    card.innerHTML =
      '<div class="admin-card-header">'+
        '<div class="admin-card-info">'+
          '<div class="admin-card-name">'+esc(u.name)+(isSelf?' <span style="color:var(--dim);font-size:10px;">(tu)</span>':'')+'</div>'+
          '<div class="admin-card-meta">'+(u.hidden?'<span style="color:var(--dim)">üóÉ archiviato</span>':(u.active?'<span style="color:var(--green)">‚óè attivo</span>':'<span style="color:var(--red)">‚óè disattivato</span>'))+' ¬∑ '+esc(u.email||'‚Äî')+'</div>'+
        '</div>'+
        '<span class="role-badge '+u.role+'">'+u.role.replace('_',' ')+'</span>'+
        (isSelf?'':'<span class="chevron" style="margin-left:8px;">‚ñæ</span>')+
      '</div>'+
      (!isSelf?
        '<div class="user-body">'+
          '<div class="user-fields">'+
            '<input class="user-input" data-field="name" placeholder="Nome" value="'+esc(u.name)+'">'+
            '<select class="user-select" data-field="role">'+
              '<option value="operatore"'+(u.role==='operatore'?' selected':'')+'>Operatore</option>'+
              '<option value="project_manager"'+(u.role==='project_manager'?' selected':'')+'>Project Manager</option>'+
              '<option value="admin"'+(u.role==='admin'?' selected':'')+'>Admin</option>'+
            '</select>'+
          '</div>'+
          '<div class="user-actions">'+
            '<button class="ubtn save" data-uid="'+u.id+'">üíæ Salva</button>'+
            '<button class="ubtn" data-email-reset data-uid="'+u.id+'" data-email="'+esc(u.email||'')+'">üîë Reset PW</button>'+
            '<button class="ubtn '+(u.active?'off':'on')+'" data-uid="'+u.id+'" data-active="'+u.active+'">'+(u.active?'‚è∏ Disattiva':'‚ñ∂ Attiva')+'</button>'+
            '<button class="ubtn '+(u.hidden?'on':'del')+' hide-btn" data-uid="'+u.id+'" data-hidden="'+u.hidden+'">'+(u.hidden?'üì§ Ripristina':'üóÉ Archivia')+'</button>'+
          '</div>'+
        '</div>'
      :'');
    if(!isSelf){
      card.querySelector('.admin-card-header').addEventListener('click', ()=>card.classList.toggle('open'));
      card.querySelector('.ubtn.save').addEventListener('click', async e=>{
        e.stopPropagation();
        const name = card.querySelector('[data-field="name"]').value.trim();
        const role = card.querySelector('[data-field="role"]').value;
        if(!name){ toast('Nome obbligatorio'); return; }
        try{ await sb.from('profiles').update({name,role}).eq('id',u.id); await loadUserList(); toast('‚úì Utente aggiornato'); }
        catch(e){ toast('‚ö† '+e.message); }
      });
      card.querySelector('[data-email-reset]').addEventListener('click', async e=>{
        e.stopPropagation();
        const email = e.currentTarget.dataset.email;
        if(!confirm('Inviare email di reset password a "'+email+'"?')) return;
        try{ const {error}=await sb.auth.resetPasswordForEmail(email); if(error)throw error; toast('‚úì Email inviata a '+email); }
        catch(e){ toast('‚ö† '+e.message); }
      });
      card.querySelector('.ubtn[data-active]').addEventListener('click', async e=>{
        e.stopPropagation();
        const newActive = e.currentTarget.dataset.active==='true' ? false : true;
        try{ await sb.from('profiles').update({active:newActive}).eq('id',u.id); await loadUserList(); toast(newActive?'‚úì Utente attivato':'Utente disattivato'); }
        catch(e){ toast('‚ö† '+e.message); }
      });
      card.querySelector('.ubtn.hide-btn').addEventListener('click', async e=>{
        e.stopPropagation();
        const newHidden = e.currentTarget.dataset.hidden==='true' ? false : true;
        if(!confirm(newHidden?'Archiviare "'+u.name+'"?':'Ripristinare "'+u.name+'"?')) return;
        try{ await sb.from('profiles').update({hidden:newHidden}).eq('id',u.id); await loadUserList(); toast(newHidden?'Utente archiviato':'Utente ripristinato'); }
        catch(e){ toast('‚ö† '+e.message); }
      });
    }
    list.appendChild(card);
  });
}

async function createUser(){
  const name     = document.getElementById('uName').value.trim();
  const email    = document.getElementById('uEmail').value.trim();
  const password = document.getElementById('uPass').value;
  const role     = document.getElementById('uRole').value;
  if(!name||!email||!password){ toast('Compila tutti i campi'); return; }
  if(password.length < 6){ toast('Password minimo 6 caratteri'); return; }
  try {
    const {data,error} = await sbAdmin.auth.signUp({email,password,options:{data:{name,role}}});
    if(error) throw error;
    if(data.user) await sb.from('profiles').upsert({id:data.user.id,name,role,active:true},{onConflict:'id'});
    ['uName','uEmail','uPass'].forEach(id=>document.getElementById(id).value='');
    await loadUserList(); toast('‚úì Utente "'+name+'" creato');
  } catch(e){ toast('‚ö† '+e.message); }
}

/* ‚îÄ‚îÄ PROGETTI ‚îÄ‚îÄ */
async function loadProjectAdminList(){
  const [{data:projects},{data:allProfiles}] = await Promise.all([
    sb.from('projects').select('id,name,created_at,responsible_id,contracts(name)').order('created_at',{ascending:false}),
    sb.from('profiles').select('id,name,role').eq('active',true).neq('role','admin')
  ]);
  const list = document.getElementById('projectAdminList'); list.innerHTML = '';
  // Build responsible map
  const respIds = [...new Set((projects||[]).map(p=>p.responsible_id).filter(Boolean))];
  let respMap = {};
  if(respIds.length){
    const {data:rr} = await sb.from('profiles').select('id,name').in('id',respIds);
    (rr||[]).forEach(r=>respMap[r.id]=r.name);
  }
  if(!(projects||[]).length){ list.innerHTML='<div class="empty-msg">Nessun progetto.</div>'; return; }
  for(const p of (projects||[])){
    const {data:members} = await sb.from('project_members').select('user_id,profiles(id,name)').eq('project_id',p.id);
    const mList = (members||[]).map(m=>m.profiles).filter(Boolean);
    const nonMembers = (allProfiles||[]).filter(u=>!mList.find(m=>m.id===u.id));
    const card = document.createElement('div'); card.className='proj-admin-card';
    card.innerHTML =
      '<div class="proj-admin-header">'+
        '<div style="flex:1">'+
          '<div class="proj-admin-name">'+esc(p.name)+'</div>'+
          '<div class="proj-admin-meta">'+(p.contracts?.name||'Senza appalto')+' ¬∑ resp: '+(respMap[p.responsible_id]||'‚Äî')+' ¬∑ '+mList.length+' membri</div>'+
        '</div>'+
        '<span class="chevron">‚ñæ</span>'+
      '</div>'+
      '<div class="proj-admin-body">'+
        '<div class="members-title">MEMBRI</div>'+
        '<div class="mem-list">'+
          mList.map(m=>'<div class="member-row"><div class="member-name">'+esc(m.name)+'</div><button class="member-remove" data-pid="'+p.id+'" data-uid="'+m.id+'">Rimuovi</button></div>').join('')+
          (!mList.length?'<div style="color:var(--dim);font-size:12px;padding:6px 0;">Nessun membro assegnato.</div>':'')+
        '</div>'+
        (nonMembers.length?
          '<div class="add-member-wrap"><select class="member-select">'+nonMembers.map(u=>'<option value="'+u.id+'">'+esc(u.name)+' ('+u.role+')</option>').join('')+'</select><button class="add-member-btn" data-pid="'+p.id+'">Ôºã Aggiungi</button></div>':'')+
        '<div class="members-title">RESPONSABILE</div>'+
        '<div class="add-member-wrap">'+
          '<select class="member-select" id="resp_'+p.id+'">'+
            (allProfiles||[]).map(u=>'<option value="'+u.id+'"'+(u.id===p.responsible_id?' selected':'')+'>'+esc(u.name)+'</option>').join('')+
          '</select>'+
          '<button class="add-member-btn" style="background:var(--orange);" data-pid="'+p.id+'">‚úì Salva</button>'+
        '</div>'+
        '<div class="proj-admin-actions">'+
          '<button class="proj-action-btn rename-btn" data-pid="'+p.id+'" data-name="'+esc(p.name)+'">‚úè Rinomina</button>'+
          '<button class="proj-action-btn del del-btn" data-pid="'+p.id+'" data-name="'+esc(p.name)+'">üóë Elimina</button>'+
        '</div>'+
      '</div>';
    card.querySelector('.proj-admin-header').addEventListener('click',()=>card.classList.toggle('open'));
    card.querySelectorAll('.member-remove').forEach(btn=>btn.addEventListener('click',async()=>{
      if(!confirm('Rimuovere questo membro?')) return;
      try{ const{error}=await sb.from('project_members').delete().eq('project_id',btn.dataset.pid).eq('user_id',btn.dataset.uid); if(error)throw error; await loadProjectAdminList(); toast('Membro rimosso'); }catch(e){ toast('‚ö† '+e.message); }
    }));
    const addBtn = card.querySelector('.add-member-btn:not([style])');
    if(addBtn) addBtn.addEventListener('click', async()=>{
      const sel = card.querySelector('.member-select');
      try{ const{error}=await sb.from('project_members').insert({project_id:addBtn.dataset.pid,user_id:sel.value}); if(error)throw error; await loadProjectAdminList(); toast('‚úì Membro aggiunto'); }catch(e){ toast('‚ö† '+e.message); }
    });
    const respBtn = card.querySelector('.add-member-btn[style]');
    if(respBtn) respBtn.addEventListener('click', async()=>{
      const sel = document.getElementById('resp_'+respBtn.dataset.pid);
      if(!sel) return;
      try{ const{error}=await sb.from('projects').update({responsible_id:sel.value}).eq('id',respBtn.dataset.pid); if(error)throw error; await loadProjectAdminList(); toast('‚úì Responsabile aggiornato'); }catch(e){ toast('‚ö† '+e.message); }
    });
    card.querySelector('.rename-btn').addEventListener('click', async()=>{
      const btn = card.querySelector('.rename-btn');
      const newName = prompt('Nuovo nome per "'+btn.dataset.name+'":')||''; if(!newName.trim()) return;
      try{ const{error}=await sb.from('projects').update({name:newName.trim()}).eq('id',btn.dataset.pid); if(error)throw error; await loadProjectAdminList(); toast('‚úì Rinominato'); }catch(e){ toast('‚ö† '+e.message); }
    });
    card.querySelector('.del-btn').addEventListener('click', async()=>{
      const btn = card.querySelector('.del-btn');
      if(!confirm('Eliminare il progetto "'+btn.dataset.name+'" e tutti i dati?')) return;
      try{ const{error}=await sb.from('projects').delete().eq('id',btn.dataset.pid); if(error)throw error; await loadProjectAdminList(); toast('Progetto eliminato'); }catch(e){ toast('‚ö† '+e.message); }
    });
    list.appendChild(card);
  }
}

async function adminCreateProject(){
  const name = document.getElementById('pName').value.trim(); if(!name){ toast('Inserisci il nome'); return; }
  const contractId = document.getElementById('pContract').value; if(!contractId){ toast('Seleziona un appalto'); return; }
  try{
    const {data:proj,error} = await sb.from('projects').insert({name,created_by:currentUser.id,responsible_id:currentUser.id,contract_id:contractId}).select().single();
    if(error) throw error;
    await sb.from('cards').insert(['01','02','03','04','05','06','07','08','09','10'].map((n,i)=>({project_id:proj.id,name:n,position:i})));
    document.getElementById('pName').value='';
    await loadProjectAdminList(); await loadContractSelect(); toast('‚úì Progetto creato');
  }catch(e){ toast('‚ö† '+e.message); }
}

/* ‚îÄ‚îÄ ANAGRAFICHE ‚îÄ‚îÄ */
const ANA_TABLES = [
  { key:'clienti',              label:'CLIENTI',                   nameField:'name', hasAlias:true },
  { key:'magazzini',            label:'MAGAZZINI',                 nameField:'nome', extra:true },
  { key:'reparti',              label:'REPARTI',                   nameField:'name', byMagazzino:true },
  { key:'marchi',               label:'MARCHI',                    nameField:'name' },
  { key:'business_types',       label:'BUSINESS TYPE',             nameField:'name' },
  { key:'settori',              label:'SETTORI',                   nameField:'name' },
  { key:'specialita',           label:'SPECIALIT√Ä',                nameField:'name' },
  { key:'temperature',          label:'TEMPERATURE',               nameField:'name' },
  { key:'unita_movimentazione', label:'UNIT√Ä DI MOVIMENTAZIONE',   nameField:'name' },
];

async function loadAnagraficheAdmin(){
  const wrap = document.getElementById('anagraficheList'); wrap.innerHTML = '';
  showLoading('CARICAMENTO ANAGRAFICHE...');
  try{
    const results = await Promise.all(ANA_TABLES.map(t=>{
      if(t.byMagazzino) return sb.from('reparti').select('id,name,magazzino_id,magazzini(nome,citta)').order('name');
      return sb.from(t.key).select('*').order(t.hasAlias?'alias':t.nameField);
    }));
    ANA_TABLES.forEach((t,i)=>{
      const rows = results[i].data||[];
      if(t.byMagazzino){
        const section = document.createElement('div'); section.className='ana-section';
        section.innerHTML='<div class="ana-section-header"><span class="ana-section-title">'+t.label+'</span><span class="ana-section-count">'+rows.length+' voci</span></div><div class="ana-section-body"></div>';
        section.querySelector('.ana-section-header').addEventListener('click',()=>section.classList.toggle('open'));
        const body = section.querySelector('.ana-section-body');
        const byMag={};
        rows.forEach(r=>{ const id=r.magazzino_id||'__none__'; if(!byMag[id])byMag[id]={label:r.magazzini?(r.magazzini.nome+(r.magazzini.citta?' ¬∑ '+r.magazzini.citta:'')):'Senza magazzino',rows:[]}; byMag[id].rows.push(r); });
        Object.entries(byMag).forEach(([magId,group])=>{
          const grpDiv=document.createElement('div'); grpDiv.style.cssText='margin-bottom:12px;';
          grpDiv.innerHTML='<div style="font-size:10px;color:var(--purple);font-family:Share Tech Mono,monospace;letter-spacing:1px;margin-bottom:6px;">üì¶ '+esc(group.label)+'</div>';
          const tagWrap=document.createElement('div'); tagWrap.style.cssText='display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;';
          group.rows.forEach(r=>{ const tag=document.createElement('span'); tag.className='ana-tag'; tag.innerHTML='<span class="ana-tag-name" style="text-decoration:underline;text-decoration-style:dotted;cursor:pointer;" data-rid="'+r.id+'">'+esc(r.name)+'</span><span class="ana-tag-del" data-id="'+r.id+'">‚úï</span>'; tagWrap.appendChild(tag); });
          grpDiv.appendChild(tagWrap);
          const fw=document.createElement('div');
          function renderRepartoForm(editRow=null){
            fw.innerHTML=''; const isEdit=!!editRow; const curVal=isEdit?(editRow.name||''):'';
            fw.innerHTML=(isEdit?'<div style="font-size:10px;color:var(--orange);font-family:Share Tech Mono,monospace;margin-bottom:5px;">‚úè '+esc(curVal)+'</div>':'')+
              '<div style="display:flex;gap:6px;"><input class="ana-new-input" data-inp="val" placeholder="'+(isEdit?'MODIFICA...':'NUOVO REPARTO...')+'" value="'+esc(curVal)+'">'+
              (isEdit?'<button class="ana-save-btn" data-act="save" style="background:var(--orange);">üíæ</button><button class="ana-cancel-btn" data-act="cancel">‚úï</button><button class="ana-save-btn" data-act="del" style="background:var(--red);">üóë</button>':'<button class="ana-save-btn" data-act="add">Ôºã</button>')+
              '</div>';
            fw.querySelectorAll('[data-act]').forEach(btn=>{ btn.addEventListener('click',async()=>{ const act=btn.dataset.act; if(act==='cancel'){renderRepartoForm(null);return;} const name=(fw.querySelector('[data-inp="val"]')?.value||'').trim().toUpperCase(); const realMagId=magId==='__none__'?null:magId; if(act==='del'){if(!confirm('Eliminare?'))return;try{const{error}=await sb.from('reparti').delete().eq('id',editRow.id);if(error)throw error;await loadAnagraficheAdmin();toast('Eliminato');}catch(e){toast('‚ö† '+e.message);}; }else if(act==='save'){if(!name){fw.querySelector('[data-inp="val"]')?.focus();return;}try{const{error}=await sb.from('reparti').update({name}).eq('id',editRow.id);if(error)throw error;await loadAnagraficheAdmin();toast('Aggiornato');}catch(e){toast('‚ö† '+e.message);}; }else{if(!name){fw.querySelector('[data-inp="val"]')?.focus();return;}try{const{error}=await sb.from('reparti').insert({name,magazzino_id:realMagId});if(error)throw error;await loadAnagraficheAdmin();toast('"'+name+'" aggiunto');}catch(e){toast(e.message.includes('unique')?'Esiste gi√†':'‚ö† '+e.message);}; } }); });
          }
          renderRepartoForm(null);
          tagWrap.querySelectorAll('.ana-tag-name').forEach(el=>{ el.addEventListener('click',e=>{e.stopPropagation();const rid=el.dataset.rid;const row=group.rows.find(r=>r.id===rid);if(!section.classList.contains('open'))section.classList.add('open');renderRepartoForm(row);fw.scrollIntoView({behavior:'smooth',block:'nearest'});}); });
          tagWrap.querySelectorAll('.ana-tag-del').forEach(btn=>{ btn.addEventListener('click',async e=>{e.stopPropagation();const row=group.rows.find(r=>r.id===btn.dataset.id);if(!confirm('Eliminare "'+row?.name+'"?'))return;try{const{error}=await sb.from('reparti').delete().eq('id',btn.dataset.id);if(error)throw error;await loadAnagraficheAdmin();toast('Eliminato');}catch(e){toast('‚ö† '+e.message);}});  });
          grpDiv.appendChild(fw); body.appendChild(grpDiv);
        });
        if(!rows.length) body.innerHTML+='<div style="color:var(--dim);font-family:Share Tech Mono,monospace;font-size:11px;padding:8px 0;">Nessun reparto.</div>';
        const addSec=document.createElement('div'); addSec.style.cssText='margin-top:10px;border-top:1px solid var(--border);padding-top:12px;';
        addSec.innerHTML='<div style="font-size:10px;color:var(--dim);font-family:Share Tech Mono,monospace;letter-spacing:1px;margin-bottom:8px;">AGGIUNGI REPARTO</div><div style="display:flex;gap:8px;flex-wrap:wrap;"><input class="ana-new-input" id="adm_rep_name" placeholder="NOME" style="flex:1.5;min-width:120px;"><select class="ana-new-input" id="adm_rep_mag" style="flex:2;min-width:140px;text-transform:none;"><option value="">‚Äî Senza magazzino ‚Äî</option></select><button class="ana-save-btn" id="adm_rep_btn" style="padding:0 16px;">Ôºã AGGIUNGI</button></div>';
        body.appendChild(addSec);
        sb.from('magazzini').select('id,nome,citta').order('nome').then(({data:mags})=>{ const sel=document.getElementById('adm_rep_mag');if(!sel)return;(mags||[]).forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.nome+(m.citta?' ¬∑ '+m.citta:'');sel.appendChild(o);}); });
        document.getElementById('adm_rep_btn')?.addEventListener('click',async()=>{ const name=(document.getElementById('adm_rep_name')?.value||'').trim().toUpperCase(); const mId=document.getElementById('adm_rep_mag')?.value||null; if(!name){document.getElementById('adm_rep_name')?.focus();return;} try{const{error}=await sb.from('reparti').insert({name,magazzino_id:mId||null});if(error)throw error;await loadAnagraficheAdmin();toast('"'+name+'" aggiunto');}catch(e){toast(e.message.includes('unique')?'Esiste gi√†':'‚ö† '+e.message);} });
        wrap.appendChild(section); return;
      }
      // Sezioni normali
      const section = document.createElement('div'); section.className='ana-section';
      section.innerHTML='<div class="ana-section-header"><span class="ana-section-title">'+t.label+'</span><span class="ana-section-count">'+rows.length+' voci</span></div><div class="ana-section-body"></div>';
      section.querySelector('.ana-section-header').addEventListener('click',()=>section.classList.toggle('open'));
      const body = section.querySelector('.ana-section-body');
      const tagWrap=document.createElement('div'); tagWrap.style.cssText='display:flex;flex-wrap:wrap;margin-bottom:8px;';
      rows.forEach(r=>{ const tag=document.createElement('span'); tag.className='ana-tag'; tag.style.cursor='pointer'; let dn; if(t.key==='magazzini') dn=(r.nome+(r.citta?' ¬∑ '+r.citta:'')); else if(t.hasAlias) dn=(r.alias||r.name)+(r.alias&&r.name?' ‚Äì '+r.name:''); else dn=r[t.nameField]; tag.innerHTML='<span class="ana-tag-name" style="text-decoration:underline;text-decoration-style:dotted;">'+esc(dn)+'</span><span class="ana-tag-del" data-id="'+r.id+'" data-table="'+t.key+'">‚úï</span>'; tagWrap.appendChild(tag); });
      body.appendChild(tagWrap);
      const formWrap=document.createElement('div'); formWrap.style.cssText='margin-top:10px;'; body.appendChild(formWrap);
      function renderForm(editRow=null){
        const isEdit=!!editRow; formWrap.innerHTML='';
        if(t.key==='magazzini'){
          const g=(f)=>isEdit?(editRow[f]||''):'';
          formWrap.innerHTML='<div style="font-size:10px;color:'+(isEdit?'var(--orange)':'var(--dim)')+';font-family:Share Tech Mono,monospace;margin-bottom:8px;">'+(isEdit?'‚úè '+esc(editRow.nome||''):'NUOVO MAGAZZINO')+'</div><div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;"><input class="ana-new-input" data-f="citta" placeholder="CITT√Ä *" value="'+esc(g('citta'))+'" style="flex:1;min-width:120px;"><input class="ana-new-input" data-f="edificio" placeholder="ID EDIFICIO (opz.)" value="'+esc(g('edificio'))+'" style="flex:1;min-width:100px;"></div><input class="ana-new-input" data-f="via" placeholder="VIA" value="'+esc(g('via'))+'" style="width:100%;margin-bottom:6px;"><div style="display:flex;gap:8px;margin-bottom:10px;"><input class="ana-new-input" data-f="civico" placeholder="CIVICO" value="'+esc(g('civico'))+'" style="flex:1;text-transform:none;"><input class="ana-new-input" data-f="cap" placeholder="CAP" value="'+esc(g('cap'))+'" style="flex:1;text-transform:none;"><input class="ana-new-input" data-f="provincia" placeholder="PROV" value="'+esc(g('provincia'))+'" style="flex:0.7;"></div><div style="display:flex;gap:8px;">'+(isEdit?'<button class="ana-save-btn" data-act="save" style="flex:1;background:var(--orange);padding:0 12px;height:36px;">üíæ Salva</button><button class="ana-cancel-btn" data-act="cancel" style="height:36px;">‚úï</button><button class="ana-save-btn" data-act="del" style="background:var(--red);height:36px;padding:0 12px;">üóë</button>':'<button class="ana-save-btn" data-act="add" style="flex:1;height:36px;">Ôºã Aggiungi magazzino</button>')+'</div>';
          const gf=()=>{const get=f=>formWrap.querySelector('[data-f="'+f+'"]')?.value||'';return{citta:get('citta').trim().toUpperCase(),edificio:get('edificio').trim().toUpperCase(),via:get('via').trim().toUpperCase(),civico:get('civico').trim(),cap:get('cap').trim(),provincia:get('provincia').trim().toUpperCase()};};
          formWrap.querySelectorAll('[data-act]').forEach(btn=>{ btn.addEventListener('click',async()=>{ const act=btn.dataset.act; if(act==='cancel'){renderForm(null);return;} const f=gf(); if(!f.citta){toast('Citt√† obbligatoria');return;} const nome=f.citta+(f.edificio?'-'+f.edificio:''); if(act==='del'){if(!confirm('Eliminare "'+editRow.nome+'"?'))return;try{const{error}=await sb.from('magazzini').delete().eq('id',editRow.id);if(error)throw error;await loadAnagraficheAdmin();toast('Eliminato');}catch(e){toast('‚ö† '+e.message);} }else if(act==='save'){try{const{error}=await sb.from('magazzini').update({nome,...f}).eq('id',editRow.id);if(error)throw error;await loadAnagraficheAdmin();toast('Aggiornato');}catch(e){toast('‚ö† '+e.message);} }else{try{const{error}=await sb.from('magazzini').insert({nome,...f,created_by:currentUser.id});if(error)throw error;await loadAnagraficheAdmin();toast('Magazzino aggiunto');}catch(e){toast('‚ö† '+e.message);}} }); });
        } else {
          const cv=isEdit?(editRow[t.nameField]||''):''; const ca=isEdit?(editRow.alias||''):'';
          formWrap.innerHTML=(isEdit?'<div style="font-size:10px;color:var(--orange);font-family:Share Tech Mono,monospace;margin-bottom:6px;">‚úè '+esc(ca||cv)+'</div>':'')+
            (t.hasAlias?'<div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;"><input class="ana-new-input" data-inp="alias" placeholder="ALIAS (es. 3M)" value="'+esc(ca)+'" style="flex:1;min-width:100px;"><input class="ana-new-input" data-inp="val" placeholder="RAGIONE SOCIALE" value="'+esc(cv)+'" style="flex:2;min-width:140px;text-transform:none;"></div>':'<div style="display:flex;gap:8px;margin-bottom:8px;"><input class="ana-new-input" data-inp="val" placeholder="'+(isEdit?'MODIFICA...':'NUOVO VALORE...')+'" value="'+esc(cv)+'"></div>')+
            '<div style="display:flex;gap:8px;">'+(isEdit?'<button class="ana-save-btn" data-act="save" style="flex:1;background:var(--orange);">üíæ Salva</button><button class="ana-cancel-btn" data-act="cancel">‚úï</button><button class="ana-save-btn" data-act="del" style="background:var(--red);">üóë</button>':'<button class="ana-save-btn" data-act="add" style="flex:1;">Ôºã Aggiungi</button>')+'</div>';
          formWrap.querySelectorAll('[data-act]').forEach(btn=>{ btn.addEventListener('click',async()=>{ const act=btn.dataset.act; if(act==='cancel'){renderForm(null);return;} const name=(formWrap.querySelector('[data-inp="val"]')?.value||'').trim(); const alias=t.hasAlias?(formWrap.querySelector('[data-inp="alias"]')?.value||'').trim().toUpperCase():null; if(act==='del'){if(!confirm('Eliminare "'+( alias||cv||ca)+'"?'))return;try{const{error}=await sb.from(t.key).delete().eq('id',editRow.id);if(error)throw error;await loadAnagraficheAdmin();toast('Eliminato');}catch(e){toast('‚ö† '+e.message);} }else if(act==='save'){if(!name){formWrap.querySelector('[data-inp="val"]')?.focus();return;}try{const obj={};obj[t.nameField]=name;if(t.hasAlias)obj.alias=alias;const{error}=await sb.from(t.key).update(obj).eq('id',editRow.id);if(error)throw error;await loadAnagraficheAdmin();toast('Aggiornato');}catch(e){toast(e.message.includes('unique')?'Esiste gi√†':'‚ö† '+e.message);} }else{if(!name){formWrap.querySelector('[data-inp="val"]')?.focus();return;}try{const obj={};obj[t.nameField]=name;if(t.hasAlias)obj.alias=alias;const{error}=await sb.from(t.key).insert(obj);if(error)throw error;await loadAnagraficheAdmin();toast('"'+(alias||name)+'" aggiunto');}catch(e){toast(e.message.includes('unique')?'Esiste gi√†':'‚ö† '+e.message);}} }); });
        }
      }
      renderForm(null);
      tagWrap.querySelectorAll('.ana-tag-name').forEach((nameEl,idx)=>{ nameEl.addEventListener('click',e=>{ e.stopPropagation(); const row=rows[idx]; if(!section.classList.contains('open'))section.classList.add('open'); renderForm(row); formWrap.scrollIntoView({behavior:'smooth',block:'nearest'}); }); });
      tagWrap.querySelectorAll('.ana-tag-del').forEach((btn,idx)=>{ btn.addEventListener('click',async e=>{ e.stopPropagation(); const row=rows[idx]; const lbl=t.key==='magazzini'?(row.nome||''):row[t.nameField]; if(!confirm('Eliminare "'+lbl+'"?'))return; try{const{error}=await sb.from(t.key).delete().eq('id',row.id);if(error)throw error;await loadAnagraficheAdmin();toast('"'+lbl+'" eliminato');}catch(e){toast('‚ö† '+e.message);} }); });
      wrap.appendChild(section);
    });
  }catch(e){ wrap.innerHTML='<div style="color:var(--red);padding:20px;font-family:Share Tech Mono,monospace;">'+esc(e.message)+'</div>'; }
  finally{ hideLoading(); }
}

/* ‚îÄ‚îÄ BACKUP ‚îÄ‚îÄ */
function switchBackupType(type){
  _backupType = type;
  ['contracts','projects','log_entries'].forEach(t=>{
    const id = {contracts:'bbtContracts',projects:'bbtProjects',log_entries:'bbtLog'}[t];
    document.getElementById(id)?.classList.toggle('active', t===type);
  });
  fetchAndRenderBackup();
}

async function fetchAndRenderBackup(){
  document.getElementById('backupList').innerHTML = '<div class="backup-empty">CARICAMENTO...</div>';
  try {
    const { data, error } = await sb.from(_backupType+'_backup')
      .select('*').order('backup_at',{ascending:false}).limit(300);
    if(error) throw error;
    _backupData = data||[];
    renderBackupList();
  } catch(e){
    document.getElementById('backupList').innerHTML = '<div class="backup-empty">‚ö† '+esc(e.message)+'</div>';
  }
}

function renderBackupList(){
  const listEl = document.getElementById('backupList'); if(!listEl) return;
  const filter = document.getElementById('backupActionFilter')?.value||'';
  const filtered = filter ? _backupData.filter(r=>r.backup_action===filter) : _backupData;
  if(!filtered.length){ listEl.innerHTML='<div class="backup-empty">Nessun record nel backup.</div>'; return; }
  listEl.innerHTML = '<div style="font-size:11px;color:var(--dim);font-family:\'Share Tech Mono\',monospace;margin-bottom:10px;">'+filtered.length+' record</div>';
  filtered.forEach(r=>{
    const isDeleted = r.backup_action==='DELETE';
    const isUpdated = r.backup_action==='UPDATE';
    const label = r.name||r.card_name||r.id||'‚Äî';
    const dt = r.backup_at ? new Date(r.backup_at).toLocaleString('it-IT') : '‚Äî';
    let detail = '';
    if(_backupType==='log_entries') detail=(r.card_name||'‚Äî')+' ¬∑ '+(r.user_name||'‚Äî')+' ¬∑ '+(r.started_at?new Date(r.started_at).toLocaleDateString('it-IT'):'‚Äî');
    else if(_backupType==='projects') detail='appalto: '+(r.contract_id||'').slice(0,8)+'‚Ä¶';
    else detail='id: '+(r.id||'').slice(0,8)+'‚Ä¶';
    const div=document.createElement('div');
    div.className='backup-row'+(isDeleted?' deleted':isUpdated?' updated':'');
    div.innerHTML=
      '<div class="backup-row-info">'+
        '<div class="backup-row-name">'+esc(label)+'</div>'+
        '<div class="backup-row-meta">'+esc(dt)+'<br>'+esc(detail)+'</div>'+
      '</div>'+
      '<span class="backup-action-badge badge-'+r.backup_action+'">'+r.backup_action+'</span>'+
      (isDeleted?'<button class="restore-btn" data-bid="'+r.backup_id+'">‚Ü© Ripristina</button>':'');
    if(isDeleted) div.querySelector('.restore-btn').addEventListener('click',async()=>{
      const bid=parseInt(div.querySelector('.restore-btn').dataset.bid);
      if(!confirm('Ripristinare questo record eliminato?')) return;
      const rpcFn={contracts:'fn_restore_contract',projects:'fn_restore_project',log_entries:'fn_restore_log_entry'}[_backupType];
      try{ const{data,error}=await sb.rpc(rpcFn,{p_backup_id:bid}); if(error)throw error; toast(data||'‚úì Ripristinato'); await fetchAndRenderBackup(); }
      catch(e){ toast('‚ö† '+e.message); }
    });
    listEl.appendChild(div);
  });
}

/* ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ */
(async function boot(){
  showLoading('CONNESSIONE...');
  const safety = setTimeout(()=>{ hideLoading(); document.getElementById('loginScreen').classList.remove('hidden'); }, 8000);
  try {
    const { data:{ session }, error } = await sb.auth.getSession();
    if(error) throw error;
    if(session){
      const { data:prof } = await sb.from('profiles').select('name,role,active').eq('id',session.user.id).single();
      if(prof?.active && prof.role==='admin'){
        currentUser = { id:session.user.id, email:session.user.email, name:prof.name, role:prof.role };
        clearTimeout(safety); hideLoading(); afterLogin(); return;
      }
    }
  } catch(e){ console.error(e); }
  clearTimeout(safety);
  hideLoading();
  document.getElementById('loginScreen').classList.remove('hidden');
})();
</script>
</body>
</html>
