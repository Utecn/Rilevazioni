<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#060608">
<title>Rilevazioni</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#060608;--panel:#0d0d12;--card:#111118;--card2:#16161f;
  --border:#1e1e2e;--border2:#2a2a3e;--text:#c8c8d8;--dim:#4a4a6a;
  --orange:#ff5500;--orange-dim:rgba(255,85,0,0.15);--orange-glow:rgba(255,85,0,0.4);
  --cyan:#00e5ff;--cyan-dim:rgba(0,229,255,0.1);--green:#00ff88;--purple:#b388ff;--red:#ff3355;
}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;display:flex;flex-direction:column;height:100dvh;overflow:hidden;}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading-screen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
.loading-screen.hidden{display:none;}
.loader{width:36px;height:36px;border:3px solid var(--border2);border-top-color:var(--orange);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--dim);letter-spacing:2px;}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.login-screen{position:fixed;inset:0;z-index:800;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:24px;}
.login-screen.hidden{display:none;}
.login-box{width:100%;max-width:340px;display:flex;flex-direction:column;align-items:center;}
.login-logo{font-size:13px;font-weight:700;letter-spacing:5px;color:var(--dim);text-transform:uppercase;margin-bottom:36px;font-family:'Share Tech Mono',monospace;}
.login-logo span{color:var(--orange);}
.login-title{font-size:24px;font-weight:700;letter-spacing:1px;margin-bottom:4px;}
.login-sub{font-size:12px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-bottom:28px;letter-spacing:1px;}
.login-field{width:100%;margin-bottom:12px;}
.login-label{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;display:block;margin-bottom:6px;font-family:'Share Tech Mono',monospace;}
.login-input{width:100%;padding:13px 14px;background:var(--card);border:1px solid var(--border2);border-radius:8px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:600;outline:none;transition:border-color .15s;}
.login-input:focus{border-color:var(--orange);}
.login-btn{width:100%;padding:14px;background:var(--orange);border:none;border-radius:8px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-top:6px;box-shadow:0 0 24px rgba(255,85,0,.3);}
.login-btn:active{opacity:.8;}
.login-error{color:var(--red);font-size:12px;font-family:'Share Tech Mono',monospace;text-align:center;margin-top:10px;letter-spacing:.5px;min-height:18px;}

/* ‚îÄ‚îÄ SPLASH PROGETTO ‚îÄ‚îÄ */
.splash{position:fixed;inset:0;z-index:600;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:20px;overflow-y:auto;}
.splash.hidden{display:none;}
.splash-logo{font-size:13px;font-weight:700;letter-spacing:5px;color:var(--dim);text-transform:uppercase;margin:8px 0 20px;font-family:'Share Tech Mono',monospace;}
.splash-logo span{color:var(--orange);}
.splash-user{font-size:11px;color:var(--dim);font-family:'Share Tech Mono',monospace;letter-spacing:1px;margin-bottom:4px;}
.splash-user strong{color:var(--purple);}
.splash-title{font-size:20px;font-weight:700;letter-spacing:1px;margin-bottom:4px;text-align:center;}
.splash-sub{font-size:11px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-bottom:20px;text-align:center;}
.splash-actions{display:flex;gap:8px;width:100%;max-width:360px;margin-bottom:18px;}
.splash-new-btn{flex:1;padding:12px;background:var(--orange);border:none;border-radius:10px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:1.5px;cursor:pointer;}
.splash-new-btn:active{opacity:.8;}
.splash-admin-btn{padding:12px 13px;background:var(--card2);border:1px solid var(--purple);border-radius:10px;color:var(--purple);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;cursor:pointer;}
.splash-admin-btn:active{opacity:.7;}
.splash-logout{padding:12px 13px;background:var(--card2);border:1px solid var(--border2);border-radius:10px;color:var(--dim);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;cursor:pointer;}
.splash-logout:active{opacity:.7;}
.splash-back-btn{padding:12px 13px;background:var(--card2);border:1px solid var(--orange);border-radius:10px;color:var(--orange);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;cursor:pointer;}
.splash-back-btn:active{opacity:.7;}
.contract-item{display:flex;align-items:center;background:var(--card);border:1px solid var(--border2);border-radius:8px;overflow:hidden;cursor:pointer;transition:border-color .15s;}
.contract-item:hover{border-color:var(--purple);}
.contract-item:active{opacity:.75;}
.contract-item-body{flex:1;padding:14px 16px;}
.contract-item-name{font-size:15px;font-weight:700;color:var(--text);}
.contract-item-meta{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:3px;}
.contract-item-arrow{padding:0 16px;align-self:stretch;display:flex;align-items:center;color:var(--purple);font-size:16px;}
.contract-item-del{padding:0 14px;align-self:stretch;display:flex;align-items:center;border-left:1px solid var(--border2);color:var(--red);font-size:16px;cursor:pointer;}
.proj-list-wrap{width:100%;max-width:360px;}
.proj-list-label{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:8px;font-family:'Share Tech Mono',monospace;padding-left:4px;}
.proj-list{display:flex;flex-direction:column;gap:6px;}
.proj-item-wrap{display:flex;align-items:center;gap:6px;}
.proj-item{flex:1;display:flex;align-items:center;background:var(--card);border:1px solid var(--border2);border-radius:8px;overflow:hidden;cursor:pointer;min-width:0;}
.proj-item:active{opacity:.75;}
.proj-item-body{flex:1;padding:12px 14px;min-width:0;}
.proj-item-name{font-size:15px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.proj-item-meta{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:2px;}
.proj-item-del{width:44px;align-self:stretch;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:var(--card);border:1px solid var(--red);border-radius:8px;color:var(--red);font-size:16px;cursor:pointer;touch-action:manipulation;}
.proj-item-del:active{opacity:.6;}
.proj-item-team{width:44px;align-self:stretch;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:rgba(179,136,255,0.08);border:2px solid var(--purple);border-radius:8px;color:var(--purple);font-size:18px;cursor:pointer;touch-action:manipulation;}
.proj-item-team:active{opacity:.6;}
.proj-empty{padding:30px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--dim);line-height:2;}
.proj-toggle-wrap{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:360px;margin-bottom:10px;padding:0 2px;}
.proj-toggle-label{font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase;font-family:'Share Tech Mono',monospace;}
.proj-toggle{position:relative;width:40px;height:22px;cursor:pointer;}
.proj-toggle input{opacity:0;width:0;height:0;position:absolute;}
.proj-toggle-slider{position:absolute;inset:0;background:var(--border2);border-radius:22px;transition:background .2s;}
.proj-toggle-slider::before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform .2s;}
.proj-toggle input:checked + .proj-toggle-slider{background:var(--orange);}
.proj-toggle input:checked + .proj-toggle-slider::before{transform:translateX(18px);}
.proj-section-label{font-size:9px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;font-family:'Share Tech Mono',monospace;padding:10px 4px 4px;opacity:.7;}
.proj-item.mine{border-color:var(--orange);}
.proj-item.member{border-color:var(--border2);}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{flex-shrink:0;display:flex;align-items:center;padding:9px 10px;background:var(--panel);border-bottom:1px solid var(--border);gap:6px;}
.proj-selector{flex:1;min-width:0;display:flex;align-items:center;gap:6px;background:var(--card2);border:1px solid var(--border2);border-radius:6px;padding:6px 10px;cursor:pointer;overflow:hidden;}
.proj-selector:active{opacity:.75;}
.proj-selector-icon{color:var(--purple);font-size:14px;flex-shrink:0;}
.proj-selector-name{font-size:13px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.proj-selector-arrow{color:var(--dim);font-size:10px;flex-shrink:0;}
.hbtn{background:var(--card2);border:1px solid var(--border2);color:var(--text);padding:6px 9px;border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;cursor:pointer;white-space:nowrap;flex-shrink:0;}
.hbtn:active{opacity:.65;}
.hbtn.sort-active{border-color:var(--cyan);color:var(--cyan);}
.hbtn.add{background:var(--orange);border-color:var(--orange);color:#fff;}
.hbtn.hist{border-color:var(--green);color:var(--green);}
.hbtn.home{border-color:var(--border2);color:var(--dim);font-size:16px;padding:5px 9px;}

/* ‚îÄ‚îÄ SORT BANNER ‚îÄ‚îÄ */
.sort-banner{display:none;flex-shrink:0;background:rgba(0,229,255,.05);border-bottom:1px solid var(--cyan);padding:7px 14px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--cyan);letter-spacing:1px;text-align:center;}
.sort-banner.show{display:block;}

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.scroll-area{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:12px;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;grid-auto-rows:130px;}
@media(min-width:480px){.grid{grid-template-columns:repeat(3,1fr);grid-auto-rows:140px;}}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:var(--card);border:1px solid var(--border2);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:18px 10px 13px;position:relative;cursor:pointer;user-select:none;-webkit-user-select:none;transition:border-color .2s,background .2s;overflow:hidden;touch-action:pan-y;}
.card::after{content:'';position:absolute;inset:0;border-radius:10px;background:linear-gradient(160deg,rgba(255,255,255,.025) 0%,transparent 60%);pointer-events:none;}
.card.on{border-color:var(--orange);background:linear-gradient(160deg,rgba(255,85,0,.1) 0%,var(--card) 70%);box-shadow:0 0 20px rgba(255,85,0,.1);}
.card.drag-src{opacity:.3;}
.card.drag-over{border-color:var(--cyan);background:var(--cyan-dim);}
@keyframes scanline{0%{top:-3px}100%{top:100%}}
.scan{display:none;position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--orange),transparent);animation:scanline 2.2s linear infinite;pointer-events:none;z-index:1;}
.card.on .scan{display:block;}
.dot{position:absolute;top:8px;right:8px;width:7px;height:7px;border-radius:50%;background:var(--dim);transition:background .2s;}
.card.on .dot{background:var(--orange);box-shadow:0 0 8px var(--orange);animation:blink 1.2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.badge{position:absolute;top:7px;left:8px;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--dim);}
.card.on .badge{color:var(--orange);}
.sort-handle{display:none;position:absolute;top:5px;left:50%;transform:translateX(-50%);color:var(--cyan);font-size:11px;letter-spacing:3px;pointer-events:none;}
body.sort-mode .sort-handle{display:block;}
.card-name{font-size:14px;font-weight:600;letter-spacing:.5px;text-align:center;color:var(--text);line-height:1.25;word-break:break-word;max-width:100%;padding:0 4px;margin-top:10px;}
.card.on .card-name{color:#fff;}
.card-timer{font-family:'Share Tech Mono',monospace;font-size:17px;color:var(--dim);transition:color .2s;}
.card.on .card-timer{color:var(--orange);text-shadow:0 0 10px var(--orange-glow);}
.card-btn{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;padding:5px 14px;border-radius:4px;border:1px solid var(--border2);background:transparent;pointer-events:none;transition:all .2s;font-family:'Rajdhani',sans-serif;}
.card.on .card-btn{color:var(--orange);border-color:var(--orange);background:var(--orange-dim);}
.card-qty{position:absolute;bottom:7px;right:8px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);background:var(--card2);border:1px solid var(--border2);border-radius:4px;padding:2px 6px;cursor:pointer;z-index:2;line-height:1.5;transition:color .15s,border-color .15s;}
.card.on .card-qty{color:var(--orange);border-color:rgba(255,85,0,0.4);}
.qty-controls{display:flex;align-items:center;gap:16px;justify-content:center;margin:20px 0 16px;}
.qty-btn{width:52px;height:52px;border-radius:50%;border:2px solid var(--border2);background:var(--card2);color:var(--text);font-size:26px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;}
.qty-btn:active{opacity:.65;transform:scale(.93);}
.qty-input{font-family:'Share Tech Mono',monospace;font-size:38px;color:var(--orange);background:transparent;border:none;outline:none;text-align:center;width:90px;caret-color:var(--orange);}
.rec-qty{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--cyan);white-space:nowrap;padding:1px 6px;background:rgba(0,229,255,0.08);border:1px solid rgba(0,229,255,0.2);border-radius:3px;}
.ana-add-btn{flex-shrink:0;background:var(--card);border:1px solid var(--border2);color:var(--dim);width:34px;height:34px;border-radius:6px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;font-weight:700;}
.ana-add-btn:active{opacity:.6;}
.ana-save-btn{flex-shrink:0;background:var(--purple);border:none;color:#000;padding:0 12px;height:34px;border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;}
.ana-cancel-btn{flex-shrink:0;background:var(--card);border:1px solid var(--border2);color:var(--dim);padding:0 10px;height:34px;border-radius:6px;font-size:13px;cursor:pointer;}
.specialita-chip{display:inline-flex;align-items:center;gap:5px;background:rgba(179,136,255,0.15);border:1px solid var(--purple);border-radius:4px;padding:3px 8px;font-size:11px;font-weight:700;color:var(--purple);font-family:'Rajdhani',sans-serif;}
.specialita-chip-remove{cursor:pointer;color:var(--red);font-size:13px;line-height:1;}
.specialita-chip-remove:hover{opacity:.7;}
/* ANAGRAFICHE admin section */
.ana-section{background:var(--card);border:1px solid var(--border2);border-radius:8px;margin-bottom:10px;overflow:hidden;}
.ana-section-header{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;cursor:pointer;background:var(--card2);}
.ana-section-title{font-size:12px;font-weight:700;letter-spacing:1.5px;color:var(--text);text-transform:uppercase;}
.ana-section-count{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;}
.ana-section-body{display:none;padding:10px 14px 14px;}
.ana-section.open .ana-section-body{display:block;}
.ana-tag{display:inline-flex;align-items:center;gap:5px;background:var(--card2);border:1px solid var(--border2);border-radius:4px;padding:4px 8px;font-size:12px;font-weight:600;margin:3px;cursor:default;}
.ana-tag-del{color:var(--red);cursor:pointer;font-size:13px;padding:0 2px;}
.ana-tag-del:hover{opacity:.7;}
.ana-add-row{display:flex;gap:6px;margin-top:10px;}
.ana-new-input{flex:1;padding:8px 10px;background:var(--bg);border:1px solid var(--border2);border-radius:6px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;outline:none;text-transform:uppercase;}
.ana-new-input:focus{border-color:var(--purple);}
.mag-form{background:var(--card2);border:1px solid var(--border2);border-radius:6px;padding:10px;margin-bottom:8px;}
.mag-item{display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.mag-item:last-child{border-bottom:none;}
.mag-item-info{flex:1;}
.mag-item-name{font-size:13px;font-weight:700;}
.mag-item-meta{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:2px;}

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
.footer{flex-shrink:0;display:flex;border-top:1px solid var(--border);background:var(--panel);}
.stat{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 4px;border-right:1px solid var(--border);gap:1px;}
.stat:last-child{border-right:none;}
.stat-val{font-family:'Share Tech Mono',monospace;font-size:15px;color:var(--orange);}
.stat-lbl{font-size:9px;font-weight:600;letter-spacing:1px;color:var(--dim);text-transform:uppercase;}

/* ‚îÄ‚îÄ OVERLAY / SHEET ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);backdrop-filter:blur(6px);display:flex;align-items:flex-end;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.show{opacity:1;pointer-events:all;}
.sheet{background:var(--panel);border:1px solid var(--border2);border-bottom:none;border-radius:16px 16px 0 0;width:100%;max-width:500px;padding:20px 16px 32px;transform:translateY(40px);transition:transform .25s cubic-bezier(.34,1.4,.64,1);max-height:85vh;overflow-y:auto;}
.overlay.show .sheet{transform:translateY(0);}
.sheet-title{font-size:10px;font-weight:700;letter-spacing:2.5px;color:var(--dim);text-transform:uppercase;margin-bottom:14px;font-family:'Share Tech Mono',monospace;}
.sheet-opt{display:flex;align-items:center;gap:12px;background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:13px 14px;margin-bottom:8px;cursor:pointer;font-size:15px;font-weight:600;color:var(--text);}
.sheet-opt:active{opacity:.7;}
.sheet-opt.danger{color:var(--red);}
.sheet-opt-icon{font-size:18px;width:24px;text-align:center;}
.sheet-cancel{width:100%;padding:12px;background:transparent;border:1px solid var(--border2);border-radius:8px;color:var(--dim);font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;letter-spacing:1px;cursor:pointer;margin-top:4px;}
.sheet-cancel:active{opacity:.7;}
.text-input{width:100%;padding:13px 12px;background:var(--card);border:1px solid var(--border2);border-radius:8px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:600;outline:none;margin-bottom:10px;transition:border-color .15s;}
.text-input:focus{border-color:var(--orange);}
.confirm-btn{width:100%;padding:13px;background:var(--orange);border:none;border-radius:8px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-bottom:8px;}
.confirm-btn:active{opacity:.8;}

/* ‚îÄ‚îÄ STORICO ‚îÄ‚îÄ */
.history-screen{position:fixed;inset:0;z-index:500;background:var(--bg);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);}
.history-screen.show{transform:translateX(0);}
.hist-header{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);}
.hist-back{background:var(--card2);border:1px solid var(--border2);color:var(--text);padding:6px 12px;border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
.hist-back:active{opacity:.7;}
.hist-title{flex:1;font-size:13px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;}
.hist-title span{color:var(--green);}
.hist-proj{font-size:10px;color:var(--purple);font-family:'Share Tech Mono',monospace;}
.hist-toolbar{flex-shrink:0;display:flex;align-items:center;gap:8px;padding:9px 12px;background:var(--panel);border-bottom:1px solid var(--border);flex-wrap:wrap;}
.filter-select{flex:1;min-width:0;padding:7px 10px;background:var(--card2);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;outline:none;}
.exp-btn{background:var(--green);border:none;color:#000;padding:7px 11px;border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;}
.exp-btn:active{opacity:.75;}
.clear-btn{background:transparent;border:1px solid var(--red);color:var(--red);padding:7px 10px;border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;}
.clear-btn:active{opacity:.7;}
.hist-summary{flex-shrink:0;display:flex;border-bottom:1px solid var(--border);background:var(--panel);}
.hstat{flex:1;display:flex;flex-direction:column;align-items:center;padding:7px 4px;border-right:1px solid var(--border);gap:1px;}
.hstat:last-child{border-right:none;}
.hstat-val{font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--green);}
.hstat-lbl{font-size:9px;font-weight:600;letter-spacing:1px;color:var(--dim);text-transform:uppercase;}
.hist-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.hist-empty{padding:60px 20px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--dim);line-height:2;}
.day-group{margin-bottom:2px;}
.day-label{padding:8px 14px 4px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);letter-spacing:1px;text-transform:uppercase;position:sticky;top:0;background:var(--bg);z-index:1;border-bottom:1px solid var(--border);}
.rec-row{display:flex;align-items:center;border-bottom:1px solid var(--border);padding:10px 12px;gap:10px;}
.rec-row:active{background:var(--card2);}
.rec-name{flex:1;font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rec-info{text-align:center;}
.rec-time{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);white-space:nowrap;line-height:1.7;}
.rec-user{font-size:9px;color:var(--purple);font-family:'Share Tech Mono',monospace;margin-top:1px;}
.rec-dur{font-family:'Share Tech Mono',monospace;font-size:14px;color:var(--orange);font-weight:700;white-space:nowrap;min-width:70px;text-align:right;}
.rec-wrap{position:relative;overflow:hidden;border-bottom:1px solid var(--border);touch-action:pan-y;user-select:none;}
/* ‚îÄ‚îÄ REC-WRAP: sfondo sinistro (elimina) e destro (riassegna) ‚îÄ‚îÄ */
.rec-del-bg{position:absolute;inset:0;background:var(--red);display:flex;align-items:center;justify-content:flex-end;padding-right:24px;opacity:0;pointer-events:none;z-index:0;}
.rec-del-bg.show{pointer-events:all;}
.rec-del-bg span{color:#fff;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;cursor:pointer;}
.rec-ren-bg{position:absolute;inset:0;background:var(--purple);display:flex;align-items:center;justify-content:flex-start;padding-left:24px;opacity:0;pointer-events:none;z-index:0;}
.rec-ren-bg.show{pointer-events:all;}
.rec-ren-bg span{color:#fff;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;cursor:pointer;}
.rec-row{display:flex;align-items:center;padding:10px 12px;gap:10px;position:relative;background:var(--bg);transition:transform .2s ease,background .2s;z-index:1;}
.rec-row.swiped-left{background:rgba(255,51,85,.08);}
.rec-row.swiped-right{background:rgba(179,136,255,.08);}
.email-input{width:100%;padding:13px 12px;background:var(--card);border:1px solid var(--border2);border-radius:8px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:600;outline:none;margin-bottom:10px;transition:border-color .15s;}
.email-input:focus{border-color:var(--green);}
.exp-confirm{width:100%;padding:13px;background:var(--green);border:none;border-radius:8px;color:#000;font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-bottom:8px;}
.exp-confirm:active{opacity:.8;}
.exp-note{font-size:11px;color:var(--dim);text-align:center;font-family:'Share Tech Mono',monospace;line-height:1.6;margin-top:4px;}
.proj-sheet-item{display:flex;align-items:center;background:var(--card2);border:1px solid var(--border2);border-radius:8px;margin-bottom:8px;overflow:hidden;cursor:pointer;}
.proj-sheet-item.active-proj{border-color:var(--purple);}
.proj-sheet-item:active{opacity:.75;}
.proj-sheet-body{flex:1;padding:11px 14px;}
.proj-sheet-name{font-size:15px;font-weight:700;}
.proj-sheet-name.active-name{color:var(--purple);}
.proj-sheet-meta{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:2px;}
.proj-sheet-badge{padding:4px 8px;background:var(--purple);color:#000;border-radius:4px;font-size:10px;font-weight:700;margin-right:10px;font-family:'Share Tech Mono',monospace;}
.proj-sheet-del{padding:0 14px;align-self:stretch;display:flex;align-items:center;border-left:1px solid var(--border2);color:var(--red);font-size:16px;cursor:pointer;}
.proj-divider{border:none;border-top:1px solid var(--border2);margin:12px 0;}

/* ‚îÄ‚îÄ MEMBERS PANEL ‚îÄ‚îÄ */
.members-screen{position:fixed;inset:0;z-index:620;background:var(--bg);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);}
.members-screen.show{transform:translateX(0);}
.members-header{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);}
.members-body{flex:1;overflow-y:auto;padding:14px;}
.members-section-title{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;font-family:'Share Tech Mono',monospace;margin-bottom:8px;margin-top:16px;}
.members-section-title:first-child{margin-top:0;}
.member-chip{display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--border2);border-radius:6px;padding:10px 14px;margin-bottom:6px;}
.member-chip-name{font-size:14px;font-weight:600;}
.member-chip-remove{color:var(--red);font-size:16px;cursor:pointer;padding:0 4px;}
.member-chip-remove:active{opacity:.6;}
.member-add-row{display:flex;gap:8px;margin-top:8px;}
.member-add-select{flex:1;padding:10px 12px;background:var(--card);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;outline:none;}
.member-add-btn{padding:10px 16px;background:var(--purple);border:none;border-radius:6px;color:#fff;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;cursor:pointer;}
.member-add-btn:active{opacity:.8;}

/* ‚îÄ‚îÄ PROCESS SCREEN ‚îÄ‚îÄ */
.process-screen{position:fixed;inset:0;z-index:550;background:var(--bg);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);}
.process-screen.show{transform:translateX(0);}
.proc-header{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);}
.proc-back{background:var(--card2);border:1px solid var(--border2);color:var(--text);padding:6px 12px;border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
.proc-back:active{opacity:.7;}
.proc-title{flex:1;font-size:13px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;}
.proc-title span{color:var(--cyan);}
.proc-proj{font-size:10px;color:var(--purple);font-family:'Share Tech Mono',monospace;}
.proc-body{flex:1;overflow-y:auto;padding:12px;}
.proc-item{display:flex;align-items:center;background:var(--card);border:1px solid var(--border2);border-radius:8px;margin-bottom:8px;cursor:pointer;overflow:hidden;}
.proc-item:active{opacity:.75;}
.proc-item-body{flex:1;padding:12px 14px;}
.proc-item-name{font-size:14px;font-weight:700;color:var(--cyan);}
.proc-item-detail{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:3px;line-height:1.6;}
.proc-item-del{padding:0 14px;align-self:stretch;display:flex;align-items:center;border-left:1px solid var(--border2);color:var(--red);font-size:16px;cursor:pointer;}
.proc-empty{padding:40px 20px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--dim);line-height:2;}
.proc-add-btn{width:100%;padding:13px;background:var(--cyan);border:none;border-radius:8px;color:#000;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-bottom:10px;}
.proc-add-btn:active{opacity:.8;}
/* Form nuovo processo */
.proc-form{background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:14px;margin-bottom:12px;}
.proc-form-title{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:12px;font-family:'Share Tech Mono',monospace;}
.proc-field{margin-bottom:10px;}
.proc-label{font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase;font-family:'Share Tech Mono',monospace;display:block;margin-bottom:5px;}
.proc-select{width:100%;padding:10px 12px;background:var(--card);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;outline:none;}
.proc-select[type=text],.proc-lookup-input{text-transform:uppercase;}
.proc-select:focus{border-color:var(--cyan);}
.proc-submit{width:100%;padding:11px;background:var(--cyan);border:none;border-radius:6px;color:#000;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:1.5px;cursor:pointer;margin-top:4px;}
.proc-submit:active{opacity:.8;}
/* Indicatore processo attivo nell'header */
.proc-indicator{font-size:9px;font-family:'Share Tech Mono',monospace;color:var(--cyan);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90px;}

/* ‚îÄ‚îÄ BACKUP PANEL ‚îÄ‚îÄ */
.backup-tabs{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;}
.backup-tab-btn{flex:1;padding:9px 6px;background:var(--card2);border:1px solid var(--border2);border-radius:6px;color:var(--dim);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;text-align:center;letter-spacing:.5px;white-space:nowrap;}
.backup-tab-btn:active{opacity:.7;}
.backup-tab-btn.active{border-color:var(--orange);color:var(--orange);}
.backup-row{display:flex;align-items:flex-start;gap:10px;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:11px 12px;margin-bottom:7px;}
.backup-row.deleted{border-color:rgba(255,51,85,.4);background:rgba(255,51,85,.04);}
.backup-row.updated{border-color:rgba(0,229,255,.25);background:rgba(0,229,255,.03);}
.backup-row-info{flex:1;min-width:0;}
.backup-row-name{font-size:14px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.backup-row-meta{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:3px;line-height:1.6;}
.backup-action-badge{font-size:9px;font-weight:700;letter-spacing:1px;font-family:'Share Tech Mono',monospace;padding:3px 7px;border-radius:4px;flex-shrink:0;align-self:flex-start;}
.badge-DELETE{background:rgba(255,51,85,.2);color:var(--red);border:1px solid var(--red);}
.badge-UPDATE{background:rgba(0,229,255,.1);color:var(--cyan);border:1px solid var(--cyan);}
.badge-INSERT{background:rgba(0,255,136,.1);color:var(--green);border:1px solid var(--green);}
.restore-btn{flex-shrink:0;padding:7px 11px;background:transparent;border:1px solid var(--orange);color:var(--orange);border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;cursor:pointer;letter-spacing:.5px;}
.restore-btn:active{opacity:.7;}
.backup-empty{padding:40px 20px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--dim);line-height:2;}
.backup-filter-row{display:flex;gap:8px;margin-bottom:12px;align-items:center;}
.backup-filter-select{flex:1;padding:8px 10px;background:var(--card2);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;outline:none;}


.toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--card2);border:1px solid var(--border2);color:var(--text);padding:9px 18px;border-radius:30px;font-family:'Share Tech Mono',monospace;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;z-index:3000;transition:opacity .2s,transform .2s;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="loader"></div>
  <div class="loading-text" id="loadingText">CONNESSIONE...</div>
</div>

<!-- LOGIN -->
<div class="login-screen hidden" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">RILE<span>V</span>AZIONI</div>
    <div class="login-title">Accedi</div>
    <div class="login-sub">inserisci le tue credenziali</div>
    <div class="login-field">
      <label class="login-label">Email</label>
      <input class="login-input" id="loginEmail" type="email" autocomplete="email" placeholder="nome@azienda.com">
    </div>
    <div class="login-field">
      <label class="login-label">Password</label>
      <input class="login-input" id="loginPassword" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="login-btn" onclick="doLogin()">ACCEDI</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- SPLASH -->
<div class="splash hidden" id="splash">
  <div class="splash-logo">RILE<span>V</span>AZIONI</div>
  <div class="splash-user">Benvenuto, <strong id="splashUserName">‚Äî</strong></div>
  <div class="splash-title" id="splashTitle">Seleziona Appalto</div>
  <div class="splash-sub" id="splashSub">Cliente ¬∑ Magazzino ¬∑ Marchio</div>
  <div class="splash-actions">
    <button class="splash-back-btn" id="splashBackBtn" style="display:none" onclick="goBackToContracts()">‚Üê Appalti</button>
    <button class="splash-new-btn" id="splashNewBtn" onclick="openNewContractSheet()">Ôºã Nuovo</button>
    <button class="splash-admin-btn" id="splashAdminBtn" style="display:none" onclick="window.open('admin.html','_blank')">‚öô ADMIN</button>
    <button class="splash-logout" onclick="doLogout()">‚èª Esci</button>
  </div>
  <div class="proj-list-wrap">
    <div class="proj-list-label" id="splashListLabel">APPALTI</div>
    <div class="proj-list" id="splashList"></div>
  </div>
</div>

<!-- APP -->
<div class="header">
  <!-- ‚åÇ TASTO HOME ‚Äî torna alla selezione progetto -->
  <button class="hbtn home" onclick="goHome()" title="Home">‚åÇ</button>
  <button class="hbtn" id="btnFs" onclick="toggleFullscreen()" title="Schermo intero" style="font-size:15px;padding:5px 9px;">‚õ∂</button>
  <div class="proj-selector" onclick="openProjSheet()">
    <span class="proj-selector-icon">‚óà</span>
    <div style="flex:1;min-width:0;overflow:hidden;">
      <div class="proj-selector-name" id="projSelectorName">‚Äî</div>
      <div class="proc-indicator" id="procIndicator" style="display:none;"></div>
    </div>
    <span class="proj-selector-arrow">‚ñæ</span>
  </div>
  <button class="hbtn hist" onclick="openHistory()">üìã</button>
  <button class="hbtn" id="btnSort" onclick="toggleSort()">‚†ø</button>
  <button class="hbtn add" onclick="openAdd()">Ôºã</button>
</div>
<div class="sort-banner" id="sortBanner">‚ñ≤‚ñº  TRASCINA I TASTI ‚Äî TAP "FINE" PER USCIRE</div>
<div class="scroll-area"><div class="grid" id="grid"></div></div>
<div class="footer">
  <div class="stat"><div class="stat-val" id="fActive">0</div><div class="stat-lbl">Attivi</div></div>
  <div class="stat"><div class="stat-val" id="fTotal">0</div><div class="stat-lbl">Tasti</div></div>
  <div class="stat"><div class="stat-val" id="fMax">00:00</div><div class="stat-lbl">Max</div></div>
  <div class="stat"><div class="stat-val" id="fRec">0</div><div class="stat-lbl">Rilev.</div></div>
</div>

<!-- MEMBERS SCREEN -->
<div class="members-screen" id="membersScreen">
  <div class="members-header">
    <button class="proc-back" onclick="closeMembersScreen()">‚Üê Indietro</button>
    <div>
      <div class="proc-title">RISORSE <span style="color:var(--purple)">PROGETTO</span></div>
      <div class="proc-proj" id="membersProjLabel">‚Äî</div>
    </div>
  </div>
  <div class="members-body" id="membersBody"></div>
</div>

<!-- PROCESS SCREEN -->
<div class="process-screen" id="processScreen">
  <div class="proc-header">
    <button class="proc-back" onclick="closeProcessScreen()">‚Üê Indietro</button>
    <div>
      <div class="proc-title">SELEZIONA <span>PROCESSO</span></div>
      <div class="proc-proj" id="procProjLabel">‚Äî</div>
    </div>
  </div>
  <div class="proc-body" id="procBody"></div>
</div>

<!-- STORICO -->
<div class="history-screen" id="histScreen">
  <div class="hist-header">
    <button class="hist-back" onclick="closeHistory()">‚Üê INDIETRO</button>
    <div class="hist-title">STORICO <span>RILEVAZIONI</span></div>
    <div class="hist-proj" id="histProjLabel"></div>
  </div>
  <div class="hist-toolbar">
    <select class="filter-select" id="filterSelect" onchange="renderHistory()" style="flex:1;min-width:0;"></select>
    <button class="hbtn" id="btnAllUsers" onclick="toggleAllUsers()" title="Solo mie / Tutte" style="border-color:var(--orange);color:var(--orange);white-space:nowrap;flex-shrink:0;">üë§ IO</button>
    <button class="exp-btn" onclick="openExport()">‚¨á</button>
    <button class="clear-btn" id="clearBtn" style="display:none" onclick="confirmClear()">üóë</button>
  </div>
  <div class="hist-summary">
    <div class="hstat"><div class="hstat-val" id="hsTot">0</div><div class="hstat-lbl">Totale</div></div>
    <div class="hstat"><div class="hstat-val" id="hsMedia">‚Äî</div><div class="hstat-lbl">Media</div></div>
    <div class="hstat"><div class="hstat-val" id="hsMin">‚Äî</div><div class="hstat-lbl">Min</div></div>
    <div class="hstat"><div class="hstat-val" id="hsMax">‚Äî</div><div class="hstat-lbl">Max</div></div>
  </div>
  <div class="hist-body" id="histBody"></div>
</div>

<!-- SHEETS -->
<div class="overlay" id="ctxOverlay"><div class="sheet">
  <div class="sheet-title">OPZIONI TASTO</div>
  <div class="sheet-opt" onclick="openRename()"><span class="sheet-opt-icon">‚úèÔ∏è</span> Rinomina</div>
  <div class="sheet-opt" onclick="openSortFromCtx()"><span class="sheet-opt-icon">‚†ø</span> Sposta</div>
  <div class="sheet-opt danger" onclick="doDelete()"><span class="sheet-opt-icon">üóë</span> Elimina tasto</div>
  <button class="sheet-cancel" onclick="closeSheet('ctxOverlay')">Annulla</button>
</div></div>

<div class="overlay" id="renameOverlay"><div class="sheet">
  <div class="sheet-title">RINOMINA TASTO</div>
  <input class="text-input" id="renameInput" type="text" maxlength="30" placeholder="Nome tasto...">
  <button class="confirm-btn" onclick="doRename()">CONFERMA</button>
  <button class="sheet-cancel" onclick="closeSheet('renameOverlay')">Annulla</button>
</div></div>

<div class="overlay" id="addOverlay"><div class="sheet">
  <div class="sheet-title">NUOVO TASTO</div>
  <input class="text-input" id="addInput" type="text" maxlength="30" placeholder="Nome tasto...">
  <button class="confirm-btn" onclick="doAdd()">AGGIUNGI</button>
  <button class="sheet-cancel" onclick="closeSheet('addOverlay')">Annulla</button>
</div></div>

<div class="overlay" id="projOverlay"><div class="sheet">
  <div class="sheet-title">GESTIONE PROGETTI</div>
  <div id="projSheetList"></div>
  <hr class="proj-divider">
  <div class="sheet-opt" id="projSheetNewBtn" style="display:none" onclick="closeSheet('projOverlay');openNewProjSheet();">
    <span class="sheet-opt-icon">Ôºã</span> Nuovo Progetto
  </div>
  <button class="sheet-cancel" onclick="closeSheet('projOverlay')">Annulla</button>
</div></div>

<div class="overlay" id="newProjOverlay"><div class="sheet">
  <div class="sheet-title">NUOVO PROGETTO</div>
  <div style="margin-bottom:12px;">
    <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase;font-family:'Share Tech Mono',monospace;margin-bottom:6px;">DATA</div>
    <div style="display:flex;gap:6px;">
      <select class="text-input" id="newProjDay" style="padding:10px 8px;font-size:14px;flex:1;"></select>
      <select class="text-input" id="newProjMonth" style="padding:10px 8px;font-size:14px;flex:2;"></select>
      <select class="text-input" id="newProjYear" style="padding:10px 8px;font-size:14px;flex:1.5;"></select>
    </div>
  </div>
  <div style="margin-bottom:12px;">
    <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase;font-family:'Share Tech Mono',monospace;margin-bottom:6px;">NOME PROGETTO</div>
    <input class="text-input" id="newProjInput" type="text" maxlength="40" placeholder="Nome progetto...">
    <div style="font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:5px;letter-spacing:1px;" id="newProjPreview">‚Äî</div>
  </div>
  <div style="margin-bottom:12px;">
    <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase;font-family:'Share Tech Mono',monospace;margin-bottom:6px;">REPARTO <span style="color:var(--dim);font-weight:400;">(opzionale)</span></div>
    <div style="display:flex;gap:6px;margin-bottom:6px;">
      <select class="text-input" id="newProjReparto" style="padding:10px 12px;font-size:14px;flex:1;"><option value="">‚Äî nessuno ‚Äî</option></select>
      <button type="button" id="newProjRepartoAddBtn" onclick="toggleNewRepartoInline()" style="flex-shrink:0;padding:0 14px;background:var(--card2);border:1px solid var(--border2);color:var(--cyan);border-radius:8px;font-size:18px;cursor:pointer;">Ôºã</button>
    </div>
    <div id="newRepartoInline" style="display:none;">
      <div style="display:flex;gap:6px;">
        <input type="text" id="newRepartoInput" class="text-input" placeholder="Nome reparto..." style="flex:1;margin-bottom:0;text-transform:uppercase;">
        <button type="button" onclick="saveNewRepartoInline()" style="flex-shrink:0;padding:0 14px;background:var(--cyan);border:none;color:#000;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:Rajdhani,sans-serif;">SALVA</button>
        <button type="button" onclick="cancelNewRepartoInline()" style="flex-shrink:0;padding:0 10px;background:var(--card2);border:1px solid var(--border2);color:var(--dim);border-radius:8px;font-size:13px;cursor:pointer;">‚úï</button>
      </div>
      <div style="font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:5px;letter-spacing:.5px;" id="newRepartoNote">il reparto verr√† associato al magazzino dell'appalto</div>
    </div>
  </div>
  <div style="margin-bottom:12px;">
    <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--dim);text-transform:uppercase;font-family:'Share Tech Mono',monospace;margin-bottom:6px;">RESPONSABILE</div>
    <select class="text-input" id="newProjResponsible" style="padding:10px 12px;font-size:14px;"></select>
  </div>
  <button class="confirm-btn" onclick="doCreateProject()" style="background:var(--purple);">CREA PROGETTO</button>
  <button class="sheet-cancel" onclick="closeSheet('newProjOverlay')">Annulla</button>
</div></div>

<div class="overlay" id="renameProjOverlay"><div class="sheet">
  <div class="sheet-title">RINOMINA PROGETTO</div>
  <input class="text-input" id="renameProjInput" type="text" maxlength="40" placeholder="Nuovo nome...">
  <button class="confirm-btn" onclick="doRenameProj()" style="background:var(--purple);">CONFERMA</button>
  <button class="sheet-cancel" onclick="closeSheet('renameProjOverlay')">Annulla</button>
</div></div>

<div class="overlay" id="exportOverlay"><div class="sheet">
  <div class="sheet-title">ESPORTA IN EXCEL</div>
  <input class="email-input" id="emailInput" type="email" placeholder="tua@email.com (opzionale)">
  <button class="exp-confirm" onclick="doExport()">‚¨á SCARICA EXCEL</button>
  <button class="sheet-cancel" onclick="closeSheet('exportOverlay')">Annulla</button>
  <p class="exp-note">Su mobile: condivisione nativa con file allegato.<br>Su PC: download diretto.</p>
</div></div>

<div class="overlay" id="newContractOverlay"><div class="sheet" style="max-height:92vh;">
  <div class="sheet-title">NUOVO APPALTO</div>

  <!-- CLIENTE -->
  <div class="proc-field">
    <label class="proc-label">Cliente *</label>
    <div style="display:flex;gap:6px;align-items:center;">
      <select class="proc-select" id="cCliente"></select>
      <button type="button" class="ana-add-btn" onclick="toggleAnaInline('cCliente')">+</button>
    </div>
    <div id="cCliente_new" style="display:none;margin-top:6px;">
      <div style="display:flex;gap:6px;">
        <input type="text" id="cCliente_input" class="proc-select" placeholder="RAGIONE SOCIALE..." style="flex:1;text-transform:uppercase;">
        <button type="button" class="ana-save-btn" onclick="saveAnaInline('cCliente','clienti')">SALVA</button>
        <button type="button" class="ana-cancel-btn" onclick="cancelAnaInline('cCliente')">‚úï</button>
      </div>
    </div>
  </div>

  <!-- MAGAZZINO -->
  <div class="proc-field">
    <label class="proc-label">Magazzino *</label>
    <div style="display:flex;gap:6px;align-items:center;">
      <select class="proc-select" id="cMagazzino"></select>
      <button type="button" class="ana-add-btn" onclick="toggleMagazzino()">+</button>
    </div>
    <div id="cMagazzino_new" style="display:none;margin-top:6px;background:var(--card);border:1px solid var(--border2);border-radius:6px;padding:10px;">
      <div style="font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;letter-spacing:1px;margin-bottom:8px;">NUOVO MAGAZZINO</div>
      <input type="text" id="mag_citta" class="proc-select" placeholder="CITT√Ä..." style="width:100%;margin-bottom:6px;text-transform:uppercase;">
      <input type="text" id="mag_edificio" class="proc-select" placeholder="ID EDIFICIO (opz.)" style="width:100%;margin-bottom:6px;text-transform:uppercase;">
      <input type="text" id="mag_via" class="proc-select" placeholder="VIA..." style="width:100%;margin-bottom:6px;text-transform:uppercase;">
      <div style="display:flex;gap:6px;margin-bottom:6px;">
        <input type="text" id="mag_civico" class="proc-select" placeholder="CIVICO" style="flex:1;">
        <input type="text" id="mag_cap" class="proc-select" placeholder="CAP" style="flex:1;">
        <input type="text" id="mag_provincia" class="proc-select" placeholder="PROV" style="flex:0.7;text-transform:uppercase;">
      </div>
      <div style="display:flex;gap:6px;">
        <button type="button" class="ana-save-btn" style="flex:1;" onclick="saveMagazzino()">SALVA MAGAZZINO</button>
        <button type="button" class="ana-cancel-btn" onclick="cancelAnaInline('cMagazzino')">‚úï</button>
      </div>
    </div>
  </div>

  <!-- MARCHIO -->
  <div class="proc-field">
    <label class="proc-label">Marchio</label>
    <div style="display:flex;gap:6px;align-items:center;">
      <select class="proc-select" id="cMarchio"></select>
      <button type="button" class="ana-add-btn" onclick="toggleAnaInline('cMarchio')">+</button>
    </div>
    <div id="cMarchio_new" style="display:none;margin-top:6px;">
      <div style="display:flex;gap:6px;">
        <input type="text" id="cMarchio_input" class="proc-select" placeholder="MARCHIO..." style="flex:1;text-transform:uppercase;">
        <button type="button" class="ana-save-btn" onclick="saveAnaInline('cMarchio','marchi')">SALVA</button>
        <button type="button" class="ana-cancel-btn" onclick="cancelAnaInline('cMarchio')">‚úï</button>
      </div>
    </div>
  </div>

  <!-- BUSINESS -->
  <div class="proc-field">
    <label class="proc-label">Business *</label>
    <div style="display:flex;gap:6px;align-items:center;">
      <select class="proc-select" id="cBusiness"></select>
      <button type="button" class="ana-add-btn" onclick="toggleAnaInline('cBusiness')">+</button>
    </div>
    <div id="cBusiness_new" style="display:none;margin-top:6px;">
      <div style="display:flex;gap:6px;">
        <input type="text" id="cBusiness_input" class="proc-select" placeholder="BUSINESS..." style="flex:1;text-transform:uppercase;">
        <button type="button" class="ana-save-btn" onclick="saveAnaInline('cBusiness','business_types')">SALVA</button>
        <button type="button" class="ana-cancel-btn" onclick="cancelAnaInline('cBusiness')">‚úï</button>
      </div>
    </div>
  </div>

  <!-- SETTORE -->
  <div class="proc-field">
    <label class="proc-label">Settore *</label>
    <div style="display:flex;gap:6px;align-items:center;">
      <select class="proc-select" id="cSettore"></select>
      <button type="button" class="ana-add-btn" onclick="toggleAnaInline('cSettore')">+</button>
    </div>
    <div id="cSettore_new" style="display:none;margin-top:6px;">
      <div style="display:flex;gap:6px;">
        <input type="text" id="cSettore_input" class="proc-select" placeholder="SETTORE..." style="flex:1;text-transform:uppercase;">
        <button type="button" class="ana-save-btn" onclick="saveAnaInline('cSettore','settori')">SALVA</button>
        <button type="button" class="ana-cancel-btn" onclick="cancelAnaInline('cSettore')">‚úï</button>
      </div>
    </div>
  </div>

  <!-- SPECIALIT√Ä (multi-select) -->
  <div class="proc-field">
    <label class="proc-label">Specialit√†</label>
    <div id="cSpecialitaChips" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;"></div>
    <div style="display:flex;gap:6px;align-items:center;">
      <select class="proc-select" id="cSpecialita"></select>
      <button type="button" class="ana-add-btn" onclick="addSpecialitaChip()">Ôºã</button>
      <button type="button" class="ana-add-btn" onclick="toggleAnaInline('cSpecialita')">new</button>
    </div>
    <div id="cSpecialita_new" style="display:none;margin-top:6px;">
      <div style="display:flex;gap:6px;">
        <input type="text" id="cSpecialita_input" class="proc-select" placeholder="SPECIALIT√Ä..." style="flex:1;text-transform:uppercase;">
        <button type="button" class="ana-save-btn" onclick="saveAnaInline('cSpecialita','specialita')">SALVA</button>
        <button type="button" class="ana-cancel-btn" onclick="cancelAnaInline('cSpecialita')">‚úï</button>
      </div>
    </div>
  </div>

  <!-- TEMPERATURA -->
  <div class="proc-field">
    <label class="proc-label">Temperatura *</label>
    <div style="display:flex;gap:6px;align-items:center;">
      <select class="proc-select" id="cTemperatura"></select>
      <button type="button" class="ana-add-btn" onclick="toggleAnaInline('cTemperatura')">+</button>
    </div>
    <div id="cTemperatura_new" style="display:none;margin-top:6px;">
      <div style="display:flex;gap:6px;">
        <input type="text" id="cTemperatura_input" class="proc-select" placeholder="TEMPERATURA..." style="flex:1;text-transform:uppercase;">
        <button type="button" class="ana-save-btn" onclick="saveAnaInline('cTemperatura','temperature')">SALVA</button>
        <button type="button" class="ana-cancel-btn" onclick="cancelAnaInline('cTemperatura')">‚úï</button>
      </div>
    </div>
  </div>

  <!-- UNIT√Ä MOVIMENTAZIONE -->
  <div class="proc-field">
    <label class="proc-label">Unit√† di movimentazione *</label>
    <div style="display:flex;gap:6px;align-items:center;">
      <select class="proc-select" id="cUnita"></select>
      <button type="button" class="ana-add-btn" onclick="toggleAnaInline('cUnita')">+</button>
    </div>
    <div id="cUnita_new" style="display:none;margin-top:6px;">
      <div style="display:flex;gap:6px;">
        <input type="text" id="cUnita_input" class="proc-select" placeholder="UNIT√Ä..." style="flex:1;text-transform:uppercase;">
        <button type="button" class="ana-save-btn" onclick="saveAnaInline('cUnita','unita_movimentazione')">SALVA</button>
        <button type="button" class="ana-cancel-btn" onclick="cancelAnaInline('cUnita')">‚úï</button>
      </div>
    </div>
  </div>

  <!-- ANTEPRIMA NOME -->
  <div style="background:var(--card2);border:1px solid var(--border2);border-radius:6px;padding:10px 12px;margin-top:4px;">
    <div style="font-size:9px;color:var(--dim);font-family:'Share Tech Mono',monospace;letter-spacing:1px;margin-bottom:4px;">NOME APPALTO (GENERATO)</div>
    <div id="contractPreview" style="font-size:13px;font-weight:700;color:var(--orange);">‚Äî</div>
  </div>

  <button class="confirm-btn" onclick="doCreateContract()" style="background:var(--purple);margin-top:14px;">CREA APPALTO</button>
  <button class="sheet-cancel" onclick="closeSheet('newContractOverlay')">Annulla</button>
</div></div>

<div class="overlay" id="qtyOverlay"><div class="sheet">
  <div class="sheet-title">QUANTIT√Ä ‚Äî <span id="qtyCardName" style="color:var(--orange);"></span></div>
  <div style="font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;letter-spacing:1px;margin-bottom:4px;text-align:center;">pezzi ¬∑ unit√† ¬∑ cicli</div>
  <div class="qty-controls">
    <button class="qty-btn" id="qtyMinus">‚àí</button>
    <input class="qty-input" id="qtyInput" type="number" min="1" max="9999" value="1">
    <button class="qty-btn" id="qtyPlus">Ôºã</button>
  </div>
  <button class="confirm-btn" id="qtyConfirmBtn">CONFERMA</button>
  <button class="sheet-cancel" onclick="closeSheet('qtyOverlay')">Annulla</button>
</div></div>

<div class="overlay" id="renameActivityOverlay"><div class="sheet">
  <div class="sheet-title">RIASSEGNA ATTIVIT√Ä</div>
  <div style="font-size:11px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-bottom:14px;letter-spacing:.5px;">
    Da: <span id="renameActFrom" style="color:var(--orange);"></span>
  </div>
  <div id="renameActList" style="display:flex;flex-direction:column;gap:8px;max-height:55vh;overflow-y:auto;"></div>
  <button class="sheet-cancel" style="margin-top:12px;" onclick="closeSheet('renameActivityOverlay')">Annulla</button>
</div></div>

<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL  = 'https://bjirlbcnymwibtfjovce.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqaXJsYmNueW13aWJ0ZmpvdmNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDM3ODUsImV4cCI6MjA4NzA3OTc4NX0.mDwGbTvdPxtY6gUqWus3WvrSyxy4IZdTCMurqZyhww4';

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);
const sbAdmin = createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: {
    autoRefreshToken: false,
    persistSession: false,
    storageKey: 'sb-admin-auth',
    lock: async (name, acquireTimeout, fn) => fn()
  }
});

let currentUser    = null;
let currentProject = null;
let currentContract = null;
let currentProcess  = null;
let lookups = { azioni:[], unita:[], servomezzi:[], attrezzature:[], etichette:[] };
let cards          = [];
let logEntries     = [];
let sortMode       = false;
let ctxId          = null;
let rafId          = null;
let renameProjId   = null;

function p2(n){ return String(n).padStart(2,'0'); }
function fmt(ms){
  const mil=String(Math.floor(ms%1000)).padStart(3,'0'),s=Math.floor(ms/1000),
        h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;
  return (h>0?p2(h)+':':'')+p2(m)+':'+p2(ss)+'.'+mil;
}
function fmtS(ms){
  const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;
  return h>0?p2(h)+':'+p2(m)+':'+p2(ss):p2(m)+':'+p2(ss);
}
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function vib(n){ try{navigator.vibrate&&navigator.vibrate(n);}catch(e){} }
function dateStr(iso){ if(!iso)return'‚Äî'; const d=new Date(iso); return p2(d.getDate())+'/'+p2(d.getMonth()+1)+'/'+d.getFullYear(); }
function timeStr(iso){ if(!iso)return'‚Äî'; const d=new Date(iso); return p2(d.getHours())+':'+p2(d.getMinutes())+':'+p2(d.getSeconds()); }

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const password=document.getElementById('loginPassword').value;
  document.getElementById('loginError').textContent='';
  if(!email||!password){ document.getElementById('loginError').textContent='Inserisci email e password'; return; }
  showLoading('ACCESSO...');
  try {
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) throw error;
    const { data: prof } = await sb.from('profiles').select('name,role,active').eq('id',data.user.id).single();
    if(!prof?.active){ await sb.auth.signOut(); throw new Error('Account disattivato'); }
    currentUser = { id:data.user.id, email:data.user.email, name:prof.name, role:prof.role };
    hideLoading();
    await requestWakeLock();
    await tryAutoFullscreen();
    afterLogin();
  } catch(e){
    hideLoading();
    document.getElementById('loginError').textContent = e.message==='Invalid login credentials'?'Credenziali non valide':e.message;
  }
}
document.getElementById('loginEmail').addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('loginPassword').focus(); });
document.getElementById('loginPassword').addEventListener('keydown',e=>{ if(e.key==='Enter') doLogin(); });

async function doLogout(){
  await sb.auth.signOut();
  stopRealtimeSync();
  currentUser=null; currentProject=null; currentContract=null; currentProcess=null; cards=[]; logEntries=[];
  stopAllTimers(); closeAllSheets();
  document.getElementById('histScreen').classList.remove('show');
  document.getElementById('processScreen').classList.remove('show');
  document.getElementById('membersScreen').classList.remove('show');
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('loginPassword').value='';
}

function afterLogin(){
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('splashUserName').textContent = currentUser.name;
  const isAdmin = currentUser.role==='admin';
  document.getElementById('splashNewBtn').style.display    = '';
  document.getElementById('splashAdminBtn').style.display  = isAdmin?'':'none';
  document.getElementById('projSheetNewBtn').style.display = '';
  document.getElementById('clearBtn').style.display        = (isAdmin||currentUser.role==='project_manager')?'':'none';
  loadContracts();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APPALTI (CONTRATTI) + PROGETTI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Alias per compatibilit√† con chiamate esistenti
function loadSplash(){
  if(currentContract) selectContract(currentContract);
  else loadContracts();
}

async function loadContracts(){
  setSplashPhase('contracts');
  showLoading('CARICAMENTO...');
  try {
    const { data:contracts, error } = await sb.from('contracts')
      .select('id,name,created_at').order('name');
    if(error) throw error;
    const counts = await Promise.all(contracts.map(c =>
      sb.from('projects').select('id',{count:'exact',head:true}).eq('contract_id',c.id)
    ));
    const enriched = contracts.map((c,i)=>({...c, proj_count: counts[i].count||0}));
    renderContracts(enriched);
    document.getElementById('splash').classList.remove('hidden');
  } catch(e){ toast('Errore caricamento: '+e.message); }
  finally { hideLoading(); }
}

function setSplashPhase(phase){
  const isCtr = phase==='contracts';
  document.getElementById('splashTitle').textContent = isCtr ? 'Seleziona Appalto' : (currentContract?.name||'Progetti');
  document.getElementById('splashSub').textContent   = isCtr ? 'Cliente ¬∑ Magazzino ¬∑ Marchio' : 'seleziona il progetto';
  document.getElementById('splashListLabel').textContent = isCtr ? 'APPALTI' : 'PROGETTI';
  document.getElementById('splashBackBtn').style.display = isCtr ? 'none' : '';
  const btn = document.getElementById('splashNewBtn');
  if(isCtr){ btn.onclick=openNewContractSheet; btn.textContent='Ôºã Nuovo'; }
  else      { btn.onclick=openNewProjSheet;     btn.textContent='Ôºã Progetto'; }
}

function renderContracts(contracts){
  const list=document.getElementById('splashList'); list.innerHTML='';
  if(!contracts.length){
    list.innerHTML='<div class="proj-empty">Nessun appalto disponibile.<br>Crea il primo appalto.</div>';
    return;
  }
  contracts.forEach(c=>{
    const item=document.createElement('div'); item.className='contract-item';
    item.innerHTML=
      '<div class="contract-item-body">'+
        '<div class="contract-item-name">'+esc(c.name)+'</div>'+
        '<div class="contract-item-meta">'+c.proj_count+' progetti ¬∑ '+dateStr(c.created_at)+'</div>'+
      '</div>'+
      (currentUser.role==='admin'?'<div class="contract-item-del">‚úï</div>':'<div class="contract-item-arrow">‚Ä∫</div>');
    item.querySelector('.contract-item-body').addEventListener('click',()=>selectContract(c));
    item.querySelector(currentUser.role==='admin'?'.contract-item-del':'.contract-item-arrow')
      .addEventListener('click', currentUser.role==='admin'
        ? e=>{e.stopPropagation();deleteContractConfirm(c.id,c.name);}
        : ()=>selectContract(c));
    list.appendChild(item);
  });
}

async function selectContract(contract){
  currentContract = contract;
  _showAllProjects = false; // reset toggle ad ogni apertura contratto
  setSplashPhase('projects');
  await loadProjectsForContract();
}

async function loadProjectsForContract(){
  if(!currentContract) return;
  showLoading('CARICAMENTO...');
  try {
    const isAdmin = currentUser.role==='admin';

    // Fetch TUTTI i progetti del contratto
    const { data:allProjects, error } = await sb.from('projects')
      .select('id,name,created_at,responsible_id,reparto_id')
      .eq('contract_id',currentContract.id)
      .order('created_at',{ascending:false});
    if(error) throw error;

    const projIds = (allProjects||[]).map(p=>p.id);

    // Fetch memberships utente corrente
    let memberProjIds=[];
    if(projIds.length){
      const {data:mems}=await sb.from('project_members').select('project_id')
        .eq('user_id',currentUser.id).in('project_id',projIds);
      memberProjIds = (mems||[]).map(m=>m.project_id);
    }

    // "Miei" = responsabile O membro
    const myProjIds = new Set(
      (allProjects||[]).filter(p => p.responsible_id===currentUser.id || memberProjIds.includes(p.id)).map(p=>p.id)
    );

    // Scegli quali mostrare in base al toggle
    const toShow = (_showAllProjects || isAdmin)
      ? allProjects
      : (allProjects||[]).filter(p => myProjIds.has(p.id));

    // Arricchisci i progetti da mostrare
    const counts = await Promise.all((toShow||[]).map(p =>
      sb.from('log_entries').select('id',{count:'exact',head:true}).eq('project_id',p.id)
    ));
    const respIds=[...new Set((toShow||[]).map(p=>p.responsible_id).filter(Boolean))];
    let respMap={};
    if(respIds.length){
      const {data:resps}=await sb.from('profiles').select('id,name').in('id',respIds);
      (resps||[]).forEach(r=>respMap[r.id]=r.name);
    }
    const repartoIds=[...new Set((toShow||[]).map(p=>p.reparto_id).filter(Boolean))];
    let repartoMap={};
    if(repartoIds.length){
      const {data:reps}=await sb.from('reparti').select('id,name').in('id',repartoIds);
      (reps||[]).forEach(r=>repartoMap[r.id]=r.name);
    }
    const enriched = (toShow||[]).map((p,i)=>({
      ...p,
      log_count: counts[i].count||0,
      responsible_name: respMap[p.responsible_id]||'‚Äî',
      reparto_name: repartoMap[p.reparto_id]||null,
      isMember: memberProjIds.includes(p.id),
      isMine: myProjIds.has(p.id)
    }));
    // Passa anche il totale di tutti i progetti per mostrare il toggle solo se ha senso
    _allProjectsCount = allProjects.length;
    _myProjectsCount = myProjIds.size;
    renderProjects(enriched);
    document.getElementById('splash').classList.remove('hidden');
  } catch(e){ toast('Errore: '+e.message); }
  finally { hideLoading(); }
}

function goBackToContracts(){
  currentContract=null;
  loadContracts();
}

let _showAllProjects = false;
let _allProjectsCount = 0;
let _myProjectsCount = 0;

function renderProjects(projects){
  const isAdmin = currentUser.role==='admin';
  const list = document.getElementById('splashList');
  list.innerHTML = '';

  // ‚îÄ‚îÄ Toggle sempre visibile ‚îÄ‚îÄ
  {
    const toggleWrap = document.createElement('div'); toggleWrap.className='proj-toggle-wrap';
    toggleWrap.innerHTML=
      '<span class="proj-toggle-label">Tutti i progetti</span>'+
      '<label class="proj-toggle">'+
        '<input type="checkbox" id="projToggle"'+(_showAllProjects?' checked':'')+'>'+
        '<span class="proj-toggle-slider"></span>'+
      '</label>';
    list.appendChild(toggleWrap);
    document.getElementById('projToggle').addEventListener('change', async function(){
      _showAllProjects = this.checked;
      await loadProjectsForContract();
    });
  }

  if(!projects||!projects.length){
    const empty=document.createElement('div'); empty.className='proj-empty';
    empty.textContent = _showAllProjects ? 'Nessun progetto in questo appalto.' : 'Nessun progetto assegnato. Attiva "Tutti i progetti" per vedere gli altri.';
    list.appendChild(empty); return;
  }

  // ‚îÄ‚îÄ Sezioni: se toggle ON separa miei/altri ‚îÄ‚îÄ
  if(_showAllProjects && !isAdmin){
    const mine = projects.filter(p=>p.isMine);
    const others = projects.filter(p=>!p.isMine);
    if(mine.length){
      const lbl1=document.createElement('div'); lbl1.className='proj-section-label'; lbl1.textContent='I MIEI PROGETTI';
      list.appendChild(lbl1);
      mine.forEach(p=>list.appendChild(buildProjRow(p)));
    }
    if(others.length){
      const lbl2=document.createElement('div'); lbl2.className='proj-section-label'; lbl2.textContent='ALTRI PROGETTI';
      list.appendChild(lbl2);
      others.forEach(p=>list.appendChild(buildProjRow(p)));
    }
  } else {
    projects.forEach(p=>list.appendChild(buildProjRow(p)));
  }
}

function buildProjRow(p){
  const isResp = p.responsible_id === currentUser.id;
  const canManage = isResp; // solo il responsabile pu√≤ gestire risorse ed eliminare dalla lista progetti

  const wrap = document.createElement('div'); wrap.className='proj-item-wrap';

  // Card principale ‚Äî evidenziata se responsabile
  const item = document.createElement('div');
  item.className='proj-item'+(isResp?' mine':p.isMember?' member':'');
  item.innerHTML=
    '<div class="proj-item-body">'+
      '<div class="proj-item-name">'+esc(p.name)+'</div>'+
      '<div class="proj-item-meta">'+
        (isResp
          ? '<span style="color:var(--orange)">‚òÖ responsabile</span>'
          : p.isMember
            ? '<span style="color:var(--cyan)">‚óà membro</span> ¬∑ '+esc(p.responsible_name||'‚Äî')
            : esc(p.responsible_name||'‚Äî'))+
        ' ¬∑ '+p.log_count+' rilev.'+(p.reparto_name?' ¬∑ <span style="color:var(--cyan)">'+esc(p.reparto_name)+'</span>':'')+
      '</div>'+
    '</div>';
  item.addEventListener('click', ()=>selectProject(p));
  wrap.appendChild(item);

  if(canManage){
    const teamBtn = document.createElement('div'); teamBtn.className='proj-item-team';
    teamBtn.textContent='üë•';
    teamBtn.addEventListener('click', ()=>openMembersScreen(p));
    wrap.appendChild(teamBtn);

    const delBtn = document.createElement('div'); delBtn.className='proj-item-del';
    delBtn.textContent='‚úï';
    delBtn.addEventListener('click', ()=>deleteProjConfirm(p.id,p.name));
    wrap.appendChild(delBtn);
  }

  return wrap;
}

async function selectProject(proj){
  stopAllTimers(); currentProject=proj; currentProcess=null;
  document.getElementById('projSelectorName').textContent=proj.name;
  document.getElementById('procIndicator').style.display='none';
  document.getElementById('splash').classList.add('hidden');
  closeAllSheets();
  await openProcessScreen();
}

async function openProcessScreen(){
  document.getElementById('procProjLabel').textContent=currentProject?.name||'‚Äî';
  document.getElementById('processScreen').classList.add('show');
  await loadProcesses();
}

function closeProcessScreen(){
  document.getElementById('processScreen').classList.remove('show');
  document.getElementById('membersScreen').classList.remove('show');
  if(currentProject && currentProcess){
    // torna all'app senza reset
  } else {
    // torna alla lista progetti
    if(currentContract) selectContract(currentContract);
    else loadContracts();
  }
}

async function loadProcesses(){
  const body=document.getElementById('procBody'); body.innerHTML='';
  showLoading('CARICAMENTO...');
  try{
    // carica lookup se non ancora caricati
    if(!lookups.azioni.length) await loadLookups();
    const {data:procs,error}=await sb.from('processes')
      .select('id,azione_id,unita_id,servomezzo_id,attrezzatura_id,etichetta_id,azioni(name),unita(name),servomezzi(name),attrezzature(name),etichette(name)')
      .eq('project_id',currentProject.id).order('created_at');
    if(error)throw error;
    renderProcesses(procs||[]);
  }catch(e){toast('Errore: '+e.message);}
  finally{hideLoading();}
}

async function loadLookups(){
  const [a,u,s,at,e]=await Promise.all([
    sb.from('azioni').select('id,name').order('name'),
    sb.from('unita').select('id,name').order('name'),
    sb.from('servomezzi').select('id,name').order('name'),
    sb.from('attrezzature').select('id,name').order('name'),
    sb.from('etichette').select('id,name').order('name'),
  ]);
  lookups.azioni       = a.data||[];
  lookups.unita        = u.data||[];
  lookups.servomezzi   = s.data||[];
  lookups.attrezzature = at.data||[];
  lookups.etichette    = e.data||[];
}

function renderProcesses(procs){
  const body=document.getElementById('procBody'); body.innerHTML='';

  // Bottone aggiungi processo
  const addBtn=document.createElement('button'); addBtn.className='proc-add-btn';
  addBtn.textContent='Ôºã Nuovo Processo'; addBtn.onclick=()=>toggleNewProcForm(body);
  body.appendChild(addBtn);

  // Form nuovo processo (nascosto)
  const formWrap=document.createElement('div'); formWrap.id='newProcForm'; formWrap.style.display='none';
  formWrap.innerHTML=buildProcForm();
  body.appendChild(formWrap);

  if(!procs.length){
    const empty=document.createElement('div'); empty.className='proc-empty';
    empty.innerHTML='Nessun processo.<br>Crea il primo con il tasto qui sopra.';
    body.appendChild(empty);
  } else {
    procs.forEach(p=>{
      const label=[p.azioni?.name,p.unita?.name,p.servomezzi?.name,p.attrezzature?.name].filter(Boolean).join(' ¬∑ ');
      const etLabel=p.etichette?.name?'üè∑ '+p.etichette.name:'';
      const item=document.createElement('div'); item.className='proc-item';
      item.innerHTML=
        '<div class="proc-item-body">'+
          '<div class="proc-item-name">'+esc(label)+'</div>'+
          (etLabel?'<div class="proc-item-detail">'+esc(etLabel)+'</div>':'')+
        '</div>'+
        '<div class="proc-item-del">‚úï</div>';
      item.querySelector('.proc-item-body').addEventListener('click',()=>selectProcess(p,label));
      item.querySelector('.proc-item-del').addEventListener('click',async e=>{
        e.stopPropagation();
        if(!confirm('Eliminare questo processo?'))return;
        await sb.from('processes').delete().eq('id',p.id);
        await loadProcesses();
        toast('Processo eliminato');
      });
      body.appendChild(item);
    });
  }
}

function buildProcForm(){
  const opts=(arr,req)=>(req?'<option value="">‚Äî seleziona ‚Äî</option>':'<option value="">‚Äî nessuna ‚Äî</option>')+arr.map(x=>'<option value="'+x.id+'">'+esc(x.name)+'</option>').join('');
  const addBtnStyle='flex-shrink:0;background:var(--card);border:1px solid var(--border2);color:var(--dim);width:34px;height:34px;border-radius:6px;font-size:18px;cursor:pointer;';
  const saveBtnStyle='flex-shrink:0;background:var(--cyan);border:none;color:#000;padding:0 12px;border-radius:6px;font-family:Rajdhani,sans-serif;font-size:12px;font-weight:700;cursor:pointer;';
  const cancelBtnStyle='flex-shrink:0;background:var(--card);border:1px solid var(--border2);color:var(--dim);padding:0 10px;border-radius:6px;font-size:12px;cursor:pointer;';
  let html='<div class="proc-form"><div class="proc-form-title">NUOVO PROCESSO</div>';
  const fields=[
    {label:'Azione',id:'pAzione',arr:lookups.azioni,req:true},
    {label:'Unita',id:'pUnita',arr:lookups.unita,req:true},
    {label:'Servomezzo',id:'pServomezzo',arr:lookups.servomezzi,req:true},
    {label:'Attrezzatura',id:'pAttrezzatura',arr:lookups.attrezzature,req:true},
    {label:'Etichetta',id:'pEtichetta',arr:lookups.etichette,req:false}
  ];
  fields.forEach(function(f){
    html+='<div class="proc-field">';
    html+='<label class="proc-label">'+f.label+(f.req?' *':'')+'</label>';
    html+='<div style="display:flex;gap:6px;align-items:center;">';
    html+='<select class="proc-select" id="'+f.id+'">'+opts(f.arr,f.req)+'</select>';
    html+='<button type="button" style="'+addBtnStyle+'" onclick="addLookupInline(\''+f.id+'\')">+</button>';
    html+='</div>';
    html+='<div id="'+f.id+'_new" style="display:none;margin-top:6px;">';
    html+='<div style="display:flex;gap:6px;">';
    html+='<input type="text" id="'+f.id+'_input" class="proc-select" placeholder="NUOVO VALORE..." style="flex:1;text-transform:uppercase;">';
    html+='<button type="button" style="'+saveBtnStyle+'" onclick="saveLookupInline(\''+f.id+'\')">SALVA</button>';
    html+='<button type="button" style="'+cancelBtnStyle+'" onclick="cancelLookupInline(\''+f.id+'\')">X</button>';
    html+='</div></div>';
    html+='</div>';
  });
  html+='<button class="proc-submit" onclick="doCreateProcess()">CREA PROCESSO</button>';
  html+='</div>';
  return html;
}

// Mappa id select ‚Üí tabella supabase
const lookupMap = {
  pAzione:'azioni', pUnita:'unita', pServomezzo:'servomezzi',
  pAttrezzatura:'attrezzature', pEtichetta:'etichette'
};
const lookupKey = {
  pAzione:'azioni', pUnita:'unita', pServomezzo:'servomezzi',
  pAttrezzatura:'attrezzature', pEtichetta:'etichette'
};

function addLookupInline(selectId){
  const wrap = document.getElementById(selectId+'_new');
  if(!wrap) return;
  wrap.style.display = wrap.style.display==='none' ? 'block' : 'none';
  if(wrap.style.display==='block') setTimeout(()=>document.getElementById(selectId+'_input')?.focus(), 80);
}

function cancelLookupInline(selectId){
  const wrap = document.getElementById(selectId+'_new');
  if(wrap){ wrap.style.display='none'; const inp=document.getElementById(selectId+'_input'); if(inp)inp.value=''; }
}

async function saveLookupInline(selectId){
  const inp = document.getElementById(selectId+'_input');
  const name = inp?.value.trim().toUpperCase();
  if(!name){ inp?.focus(); return; }
  const table = lookupMap[selectId];
  if(!table) return;
  try{
    const {data,error} = await sb.from(table).insert({name}).select().single();
    if(error) throw error;
    // Aggiorna lookup locale
    lookups[lookupKey[selectId]].push({id:data.id,name:data.name});
    lookups[lookupKey[selectId]].sort((a,b)=>a.name.localeCompare(b.name));
    // Aggiunge opzione al select e la seleziona
    const sel = document.getElementById(selectId);
    const opt = document.createElement('option'); opt.value=data.id; opt.textContent=data.name;
    sel.appendChild(opt); sel.value=data.id;
    // Chiude il form inline
    cancelLookupInline(selectId);
    toast('‚úì "'+name+'" aggiunto');
  }catch(e){
    if(e.message.includes('unique') || e.message.includes('duplicate')){
      toast('Esiste gi√†: "'+name+'"');
    } else {
      toast('‚ö† '+e.message);
    }
  }
}

function toggleNewProcForm(body){
  const f=document.getElementById('newProcForm');
  f.style.display=f.style.display==='none'?'block':'none';
}

async function doCreateProcess(){
  const a=document.getElementById('pAzione')?.value;
  const u=document.getElementById('pUnita')?.value;
  const s=document.getElementById('pServomezzo')?.value;
  const at=document.getElementById('pAttrezzatura')?.value;
  const et=document.getElementById('pEtichetta')?.value||null;
  if(!a||!u||!s||!at){toast('Compila Azione, Unit√†, Servomezzo e Attrezzatura');return;}
  try{
    const {error}=await sb.from('processes').insert({
      project_id:currentProject.id, azione_id:a, unita_id:u,
      servomezzo_id:s, attrezzatura_id:at, etichetta_id:et||null,
      created_by:currentUser.id
    });
    if(error)throw error;
    await loadProcesses(); toast('Processo creato');
  }catch(e){toast('‚ö† '+e.message);}
}

// Enter key su input inline
document.addEventListener('keydown', e=>{
  if(e.key!=='Enter') return;
  const active = document.activeElement;
  if(active && active.id && active.id.endsWith('_input')){
    const selectId = active.id.replace('_input','');
    saveLookupInline(selectId);
  }
});

async function selectProcess(proc, label){
  // Ferma qualsiasi timer precedente prima di tutto
  if(rafId){cancelAnimationFrame(rafId);rafId=null;}
  cards.forEach(c=>{c.running=false;c.start=null;c.elapsed=0;});
  currentProcess={...proc, label};
  document.getElementById('procIndicator').textContent=label;
  document.getElementById('procIndicator').style.display='block';
  document.getElementById('processScreen').classList.remove('show');
  document.getElementById('membersScreen').classList.remove('show');
  showLoading('CARICAMENTO...');
  try{
    await loadCards();
    // Se non ci sono tasti, crea i 10 default (una volta sola)
    if(cards.length===0){
      // Ricontrolla dal DB per evitare race condition
      const {data:existing}=await sb.from('cards').select('id').eq('project_id',currentProject.id).limit(1);
      if(!existing||existing.length===0){
        const defaults=['01','02','03','04','05','06','07','08','09','10'];
        const {error}=await sb.from('cards').insert(
          defaults.map((n,i)=>({project_id:currentProject.id,name:n,position:i}))
        );
        if(error) throw error;
        await loadCards();
      } else {
        await loadCards(); // altri li hanno gi√† creati
      }
    }
    await loadLog();
  }
  catch(e){ toast('Errore: '+e.message); }
  finally{ hideLoading(); setTimeout(()=>{ renderAll(); startRealtimeSync(); },80); }
}

/* ‚îÄ‚îÄ ANAGRAFICHE LOOKUP ‚îÄ‚îÄ */
let contractLookups = { clienti:[], magazzini:[], marchi:[], business_types:[], settori:[], specialita:[], temperature:[], unita_movimentazione:[] };
let selectedSpecialita = []; // array of {id, name}

async function loadContractLookups(){
  const [cl,ma,mr,bt,se,sp,te,un] = await Promise.all([
    sb.from('clienti').select('id,alias,name').order('alias'),
    sb.from('magazzini').select('id,nome,citta,via,civico,cap,provincia,edificio').order('nome'),
    sb.from('marchi').select('id,name').order('name'),
    sb.from('business_types').select('id,name').order('name'),
    sb.from('settori').select('id,name').order('name'),
    sb.from('specialita').select('id,name').order('name'),
    sb.from('temperature').select('id,name').order('name'),
    sb.from('unita_movimentazione').select('id,name').order('name'),
  ]);
  contractLookups.clienti = cl.data||[];
  contractLookups.magazzini = ma.data||[];
  contractLookups.marchi = mr.data||[];
  contractLookups.business_types = bt.data||[];
  contractLookups.settori = se.data||[];
  contractLookups.specialita = sp.data||[];
  contractLookups.temperature = te.data||[];
  contractLookups.unita_movimentazione = un.data||[];
}

function populateContractSelects(){
  const fill = (id, arr, labelFn, empty='‚Äî seleziona ‚Äî', allowNone=false) => {
    const el = document.getElementById(id); if(!el) return;
    el.innerHTML = (allowNone ? '<option value="">‚Äî nessuno ‚Äî</option>' : '<option value="">'+empty+'</option>') +
      arr.map(x=>'<option value="'+x.id+'">'+esc(labelFn(x))+'</option>').join('');
  };
  fill('cCliente',    contractLookups.clienti,              x=>(x.alias||x.name));
  fill('cMagazzino',  contractLookups.magazzini,            x=>x.nome+(x.edificio?' ¬∑ '+x.edificio:''));
  fill('cMarchio',    contractLookups.marchi,               x=>x.name, '‚Äî nessuno ‚Äî', true);
  fill('cBusiness',   contractLookups.business_types,       x=>x.name);
  fill('cSettore',    contractLookups.settori,              x=>x.name);
  fill('cSpecialita', contractLookups.specialita,           x=>x.name);
  fill('cTemperatura',contractLookups.temperature,          x=>x.name);
  fill('cUnita',      contractLookups.unita_movimentazione, x=>x.name);
  updateContractPreview();
}

function updateContractPreview(){
  const clienteEl = document.getElementById('cCliente');
  const magazzinoEl = document.getElementById('cMagazzino');
  const marchioEl = document.getElementById('cMarchio');
  const clienteId = clienteEl?.value;
  const clienteObj = contractLookups.clienti.find(c=>c.id===clienteId);
  const clienteName = clienteObj ? (clienteObj.alias||clienteObj.name) : '';
  const magazzinoName = magazzinoEl?.selectedOptions[0]?.text || '';
  const marchioName = marchioEl?.value ? marchioEl.selectedOptions[0].text : '';
  const parts = [clienteName, magazzinoName, marchioName].filter(s=>s && s!=='‚Äî seleziona ‚Äî' && s!=='‚Äî nessuno ‚Äî');
  document.getElementById('contractPreview').textContent = parts.length ? parts.join(' ¬∑ ') : '‚Äî';
}

async function openNewContractSheet(){
  selectedSpecialita = [];
  showLoading('CARICAMENTO...');
  try{ await loadContractLookups(); }
  catch(e){ toast('‚ö† '+e.message); hideLoading(); return; }
  finally{ hideLoading(); }
  populateContractSelects();
  renderSpecialitaChips();
  // Attach preview listeners
  ['cCliente','cMagazzino','cMarchio'].forEach(id=>{
    document.getElementById(id)?.addEventListener('change', updateContractPreview);
  });
  showSheet('newContractOverlay');
}

function renderSpecialitaChips(){
  const wrap = document.getElementById('cSpecialitaChips'); if(!wrap) return;
  wrap.innerHTML = selectedSpecialita.map(s=>
    '<span class="specialita-chip">'+esc(s.name)+
    '<span class="specialita-chip-remove" data-id="'+s.id+'">‚úï</span></span>'
  ).join('');
  wrap.querySelectorAll('.specialita-chip-remove').forEach(btn=>{
    btn.addEventListener('click',()=>{
      selectedSpecialita = selectedSpecialita.filter(s=>s.id!==btn.dataset.id);
      renderSpecialitaChips();
    });
  });
}

function addSpecialitaChip(){
  const sel = document.getElementById('cSpecialita'); if(!sel||!sel.value) return;
  const id=sel.value, name=sel.selectedOptions[0].text;
  if(selectedSpecialita.find(s=>s.id===id)){ toast('Gi√† selezionata'); return; }
  selectedSpecialita.push({id,name});
  renderSpecialitaChips();
}

/* Inline add helpers for contract form */
function toggleAnaInline(fieldId){
  const wrap = document.getElementById(fieldId+'_new'); if(!wrap) return;
  wrap.style.display = wrap.style.display==='none'?'block':'none';
  if(wrap.style.display==='block') setTimeout(()=>document.getElementById(fieldId+'_input')?.focus(),80);
}
function cancelAnaInline(fieldId){
  const wrap = document.getElementById(fieldId+'_new'); if(!wrap) return;
  wrap.style.display='none';
  const inp = document.getElementById(fieldId+'_input'); if(inp) inp.value='';
  const magWrap = document.getElementById('cMagazzino_new'); if(fieldId==='cMagazzino'&&magWrap) magWrap.style.display='none';
}
function toggleMagazzino(){
  const wrap = document.getElementById('cMagazzino_new'); if(!wrap) return;
  wrap.style.display = wrap.style.display==='none'?'block':'none';
  if(wrap.style.display==='block') setTimeout(()=>document.getElementById('mag_citta')?.focus(),80);
}

async function saveAnaInline(fieldId, table){
  const inp = document.getElementById(fieldId+'_input');
  const name = inp?.value.trim().toUpperCase(); if(!name){ inp?.focus(); return; }
  try{
    const {data,error} = await sb.from(table).insert({name,created_by:currentUser.id}).select().single();
    if(error) throw error;
    // Determina quale array aggiornare
    const key = table; // stesso nome
    if(!contractLookups[key]) contractLookups[key]=[];
    contractLookups[key].push({id:data.id,name:data.name});
    contractLookups[key].sort((a,b)=>a.name.localeCompare(b.name));
    // Aggiorna select e seleziona
    const sel = document.getElementById(fieldId);
    const opt = document.createElement('option'); opt.value=data.id; opt.textContent=data.name;
    sel.appendChild(opt); sel.value=data.id;
    cancelAnaInline(fieldId); updateContractPreview();
    toast('‚úì "'+name+'" aggiunto');
  }catch(e){
    toast(e.message.includes('unique')||e.message.includes('duplicate') ? 'Esiste gi√†: "'+name+'"' : '‚ö† '+e.message);
  }
}

async function saveMagazzino(){
  const citta = document.getElementById('mag_citta')?.value.trim().toUpperCase()||'';
  const edificio = document.getElementById('mag_edificio')?.value.trim().toUpperCase()||'';
  const via = document.getElementById('mag_via')?.value.trim().toUpperCase()||'';
  const civico = document.getElementById('mag_civico')?.value.trim()||'';
  const cap = document.getElementById('mag_cap')?.value.trim()||'';
  const provincia = document.getElementById('mag_provincia')?.value.trim().toUpperCase()||'';
  if(!citta){ toast('Inserisci almeno la citt√†'); return; }
  const nome = citta+'-'+edificio;
  try{
    const {data,error} = await sb.from('magazzini').insert({nome,citta,via,civico,cap,provincia,edificio,created_by:currentUser.id}).select().single();
    if(error) throw error;
    contractLookups.magazzini.push(data);
    const sel = document.getElementById('cMagazzino');
    const opt = document.createElement('option'); opt.value=data.id; opt.textContent=data.nome+(data.edificio?' ¬∑ '+data.edificio:'');
    sel.appendChild(opt); sel.value=data.id;
    ['mag_citta','mag_edificio','mag_via','mag_civico','mag_cap','mag_provincia'].forEach(id=>{ const el=document.getElementById(id); if(el)el.value=''; });
    cancelAnaInline('cMagazzino'); updateContractPreview();
    toast('‚úì Magazzino "'+nome+'" aggiunto');
  }catch(e){
    toast(e.message.includes('unique')||e.message.includes('duplicate') ? 'Magazzino gi√† esistente' : '‚ö† '+e.message);
  }
}

async function doCreateContract(){
  const clienteId  = document.getElementById('cCliente')?.value;
  const magazzinoId= document.getElementById('cMagazzino')?.value;
  const marchioId  = document.getElementById('cMarchio')?.value || null;
  const businessId = document.getElementById('cBusiness')?.value;
  const settoreId  = document.getElementById('cSettore')?.value;
  const temperaturaId=document.getElementById('cTemperatura')?.value;
  const unitaId    = document.getElementById('cUnita')?.value;
  if(!clienteId||!magazzinoId||!businessId||!settoreId||!temperaturaId||!unitaId){
    toast('Compila i campi obbligatori (*)'); return;
  }
  const name = document.getElementById('contractPreview')?.textContent || '‚Äî';
  try{
    const {data,error}=await sb.from('contracts').insert({
      name, created_by:currentUser.id,
      cliente_id:clienteId, magazzino_id:magazzinoId, marchio_id:marchioId,
      business_id:businessId, settore_id:settoreId,
      temperatura_id:temperaturaId, unita_id:unitaId
    }).select().single();
    if(error) throw error;
    // Inserisci specialit√†
    if(selectedSpecialita.length){
      await sb.from('contract_specialita').insert(
        selectedSpecialita.map(s=>({contract_id:data.id, specialita_id:s.id}))
      );
    }
    closeSheet('newContractOverlay');
    await loadContracts();
    toast('Appalto "'+name+'" creato');
  }catch(e){
    toast('‚ö† '+e.message);
  }
}

async function deleteContractConfirm(id,name){
  if(!confirm('Eliminare l\'appalto "'+name+'" e tutti i suoi progetti?'))return;
  try{
    const {error}=await sb.from('contracts').delete().eq('id',id);
    if(error)throw error;
    if(currentContract?.id===id){currentContract=null;}
    await loadContracts();
    toast('Appalto eliminato');
  }catch(e){toast('Errore: '+e.message);}
}

/* ‚îÄ‚îÄ WAKE LOCK (schermo sempre acceso) ‚îÄ‚îÄ */
let wakeLock = null;

async function requestWakeLock(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', ()=>{ wakeLock=null; });
    }
  }catch(e){ /* non supportato o permesso negato */ }
}

// Riacquista sempre quando la pagina torna visibile
document.addEventListener('visibilitychange', async ()=>{
  if(document.visibilityState==='visible') await requestWakeLock();
});

/* ‚îÄ‚îÄ AUTO FULLSCREEN all'avvio ‚îÄ‚îÄ */
async function tryAutoFullscreen(){
  try{
    const el = document.documentElement;
    if(el.requestFullscreen) await el.requestFullscreen();
    else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
  }catch(e){ /* browser non supporta o utente ha gi√† negato */ }
}


function toggleFullscreen(){
  const btn = document.getElementById('btnFs');
  const isFs = document.fullscreenElement || document.webkitFullscreenElement;
  if(!isFs){
    const el = document.documentElement;
    if(el.requestFullscreen) el.requestFullscreen();
    else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  } else {
    if(document.exitFullscreen) document.exitFullscreen();
    else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
  }
}
document.addEventListener('fullscreenchange', updateFsBtn);
document.addEventListener('webkitfullscreenchange', updateFsBtn);
function updateFsBtn(){
  const isFs = document.fullscreenElement || document.webkitFullscreenElement;
  const btn = document.getElementById('btnFs');
  if(!btn) return;
  btn.textContent = isFs ? '‚úï‚õ∂' : '‚õ∂';
  btn.title = isFs ? 'Esci da schermo intero' : 'Schermo intero';
  btn.style.color = isFs ? 'var(--orange)' : '';
  btn.style.borderColor = isFs ? 'var(--orange)' : '';
}


let realtimeChannel = null;

function startRealtimeSync(){
  stopRealtimeSync(); // pulizia eventuale canale precedente
  if(!currentProject) return;

  realtimeChannel = sb.channel('cards-sync-'+currentProject.id)
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'cards',
      filter: 'project_id=eq.'+currentProject.id
    }, async (payload)=>{
      // Ignora se non siamo nella schermata principale
      if(!currentProject || document.getElementById('splash').classList.contains('hidden')===false) return;

      const evt = payload.eventType;
      const rec = payload.new || payload.old;

      if(evt==='INSERT'){
        // Nuovo tasto aggiunto da altro utente
        if(!cards.find(c=>c.id===rec.id)){
          cards.push({...rec, running:false, start:null, elapsed:0});
          cards.sort((a,b)=>a.position-b.position);
          renderAll();
          toast('‚Üª '+rec.name+' aggiunto da altro utente');
        }
      } else if(evt==='UPDATE'){
        const c = cards.find(x=>x.id===rec.id);
        if(c){
          const wasRunning = c.running;
          const wasStart = c.start;
          const wasElapsed = c.elapsed;
          // Aggiorna solo i campi non-runtime
          c.name = rec.name;
          c.position = rec.position;
          c.records = rec.records;
          // Riordina se necessario
          cards.sort((a,b)=>a.position-b.position);
          // Aggiorna solo l'elemento DOM senza interrompere il timer
          const el = document.querySelector('.card[data-id="'+rec.id+'"]');
          if(el){
            el.querySelector('.card-name').textContent = rec.name;
            el.querySelector('.badge').textContent = '#'+rec.records;
          } else {
            renderAll(); // rebuild completo se DOM non in sync
          }
        }
      } else if(evt==='DELETE'){
        const idx = cards.findIndex(c=>c.id===rec.id);
        if(idx>=0){
          cards[idx].running=false;
          cards.splice(idx,1);
          renderAll();
          toast('‚Üª Tasto eliminato da altro utente');
        }
      }
    })
    .subscribe();
}

function stopRealtimeSync(){
  if(realtimeChannel){
    sb.removeChannel(realtimeChannel);
    realtimeChannel = null;
  }
}


async function loadCards(){
  const { data, error } = await sb.from('cards')
    .select('*').eq('project_id',currentProject.id).order('position');
  if(error) throw error;
  cards = data.map(c=>({...c,running:false,start:null,elapsed:0,qty:1}));
}

async function loadLog(){
  const { data, error } = await sb.from('log_entries')
    .select('*').eq('project_id',currentProject.id)
    .order('started_at',{ascending:false}).limit(1000);
  if(error) throw error;
  logEntries = data;
  updateFooter();
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function renderAll(){
  const grid=document.getElementById('grid'); grid.innerHTML='';
  cards.forEach(c=>grid.appendChild(makeCard(c)));
  updateFooter();
}

function makeCard(c){
  const div=document.createElement('div');
  div.className='card'+(c.running?' on':'')+(sortMode?' sortable':'');
  div.dataset.id=c.id;
  div.innerHTML=
    '<div class="scan"></div><div class="dot"></div>'+
    '<div class="badge">#'+c.records+'</div>'+
    '<div class="sort-handle">¬∑ ¬∑ ¬∑</div>'+
    '<div class="card-name">'+esc(c.name)+'</div>'+
    '<div class="card-timer" id="t_'+c.id+'">'+fmt(c.elapsed)+'</div>'+
    '<div class="card-btn">'+(c.running?'STOP':'START')+'</div>'+
    '<div class="card-qty" id="q_'+c.id+'">√ó'+(c.qty||1)+'</div>';
  // Qty button: stop propagation so it doesn't trigger toggleCard
  const qBtn = div.querySelector('.card-qty');
  qBtn.addEventListener('touchstart', e=>e.stopPropagation(), {passive:true});
  qBtn.addEventListener('touchend', e=>{ e.stopPropagation(); e.preventDefault(); openQty(c.id); }, {passive:false});
  qBtn.addEventListener('mousedown', e=>e.stopPropagation());
  qBtn.addEventListener('click', e=>{ e.stopPropagation(); openQty(c.id); });
  attachTouch(div,c.id);
  if(sortMode){ div.draggable=true; attachDrag(div,c.id); }
  return div;
}

function attachTouch(div,id){
  let pt=null,lf=false,bm=false,sx=0,sy=0;
  div.addEventListener('touchstart',function(e){
    if(sortMode)return; const t=e.touches[0]; sx=t.clientX; sy=t.clientY; lf=false; bm=false;
    pt=setTimeout(function(){pt=null;lf=true;vib(40);ctxId=id;showSheet('ctxOverlay');},600);
  },{passive:true});
  div.addEventListener('touchmove',function(e){
    if(sortMode)return; const t=e.touches[0];
    if(Math.abs(t.clientX-sx)>20||Math.abs(t.clientY-sy)>20){bm=true;if(pt){clearTimeout(pt);pt=null;}}
  },{passive:true});
  div.addEventListener('touchend',function(e){
    if(sortMode)return;
    if(pt){clearTimeout(pt);pt=null;}
    if(!lf&&!bm){e.preventDefault();toggleCard(id);}
  },{passive:false});
  div.addEventListener('touchcancel',function(){if(pt){clearTimeout(pt);pt=null;}},{passive:true});
  let md=false,ml=null,mm=false,mlf=false,mx=0,my=0;
  div.addEventListener('mousedown',function(e){if(sortMode)return;md=true;mm=false;mlf=false;mx=e.clientX;my=e.clientY;ml=setTimeout(function(){ml=null;mlf=true;ctxId=id;showSheet('ctxOverlay');},600);});
  div.addEventListener('mousemove',function(e){if(!md)return;if(Math.abs(e.clientX-mx)>10||Math.abs(e.clientY-my)>10){mm=true;if(ml){clearTimeout(ml);ml=null;}}});
  div.addEventListener('mouseup',function(){if(!md)return;md=false;if(ml){clearTimeout(ml);ml=null;}if(!mlf&&!mm)toggleCard(id);});
  div.addEventListener('mouseleave',function(){md=false;if(ml){clearTimeout(ml);ml=null;}});
}

let _ds=null;
function attachDrag(div,id){
  div.addEventListener('dragstart',function(e){if(!sortMode){e.preventDefault();return;}_ds=id;e.dataTransfer.effectAllowed='move';setTimeout(()=>div.classList.add('drag-src'),0);});
  div.addEventListener('dragover',function(e){if(!sortMode)return;e.preventDefault();document.querySelectorAll('.card').forEach(el=>el.classList.remove('drag-over'));div.classList.add('drag-over');});
  div.addEventListener('drop',function(e){e.preventDefault();div.classList.remove('drag-over');if(_ds&&_ds!==id)swapCards(_ds,id);});
  div.addEventListener('dragend',function(){_ds=null;document.querySelectorAll('.card').forEach(el=>el.classList.remove('drag-src','drag-over'));});
}

async function swapCards(srcId,tgtId){
  const si=cards.findIndex(c=>c.id===srcId),ti=cards.findIndex(c=>c.id===tgtId);
  if(si<0||ti<0)return;
  const [r]=cards.splice(si,1); cards.splice(ti,0,r); renderAll();
  try { await Promise.all(cards.map((c,i)=>sb.from('cards').update({position:i}).eq('id',c.id))); }
  catch(e){ toast('Errore ordine'); }
}

let tDId=null,gh=null;
document.addEventListener('touchstart',function(e){
  if(!sortMode)return; const card=e.target.closest('.card'); if(!card)return;
  tDId=card.dataset.id; const t=e.touches[0];
  gh=document.createElement('div');
  Object.assign(gh.style,{position:'fixed',zIndex:'9999',padding:'10px 16px',background:'#1a1a28',border:'1px solid #00e5ff',borderRadius:'10px',fontFamily:"'Rajdhani',sans-serif",fontWeight:'700',fontSize:'14px',color:'#00e5ff',pointerEvents:'none',transform:'rotate(2deg) scale(1.05)',boxShadow:'0 8px 30px rgba(0,0,0,.6)',whiteSpace:'nowrap',left:(t.clientX-60)+'px',top:(t.clientY-25)+'px'});
  gh.textContent=cards.find(c=>c.id===tDId)?.name||''; document.body.appendChild(gh); card.classList.add('drag-src');
},{passive:true});
document.addEventListener('touchmove',function(e){
  if(!tDId||!gh)return; const t=e.touches[0];
  gh.style.left=(t.clientX-60)+'px'; gh.style.top=(t.clientY-25)+'px';
  gh.style.display='none'; const un=document.elementFromPoint(t.clientX,t.clientY); gh.style.display='';
  document.querySelectorAll('.card').forEach(el=>el.classList.remove('drag-over'));
  const ov=un?.closest('.card'); if(ov&&ov.dataset.id!==tDId)ov.classList.add('drag-over');
  e.preventDefault();
},{passive:false});
document.addEventListener('touchend',function(e){
  if(!tDId)return; gh?.remove(); gh=null;
  document.querySelectorAll('.card').forEach(el=>el.classList.remove('drag-src','drag-over'));
  const t=e.changedTouches[0]; const un=document.elementFromPoint(t.clientX,t.clientY);
  const ov=un?.closest('.card'); if(ov&&ov.dataset.id!==tDId)swapCards(tDId,ov.dataset.id); tDId=null;
});

/* ‚îÄ‚îÄ TOGGLE CRONOMETRO ‚îÄ‚îÄ */
async function toggleCard(id){
  const c=cards.find(x=>x.id===id); if(!c)return; vib(20);
  if(!c.running){
    c.running=true; c.startedAt=new Date().toISOString(); c.start=Date.now()-c.elapsed;
    const el=document.querySelector('.card[data-id="'+id+'"]');
    if(el){el.classList.add('on');el.querySelector('.card-btn').textContent='STOP';}
    startTick();
  } else {
    const endTime=new Date(); const dur=Date.now()-c.start;
    const savedQty = c.qty||1;
    c.running=false; c.start=null; c.elapsed=0; c.records++;
    const el=document.querySelector('.card[data-id="'+id+'"]');
    if(el){el.classList.remove('on');el.querySelector('.card-btn').textContent='START';el.querySelector('.card-timer').textContent='00:00.000';el.querySelector('.badge').textContent='#'+c.records;
      const qEl=el.querySelector('.card-qty'); if(qEl)qEl.textContent='√ó1';
    }
    c.qty=1;
    toast('‚úì  '+fmtS(dur)+(savedQty>1?' √ó'+savedQty:''));
    try {
      const payload = {
        project_id:currentProject.id, card_id:c.id, card_name:c.name,
        user_id:currentUser.id, user_name:currentUser.name,
        started_at:c.startedAt, ended_at:endTime.toISOString(), duration_ms:dur,
        process_id:currentProcess?.id||null, quantity:savedQty
      };
      let res = await sb.from('log_entries').insert(payload).select().single();
      // Se fallisce per la colonna quantity inesistente, riprova senza
      if(res.error && res.error.message && res.error.message.includes('quantity')){
        const {quantity:_, ...payloadNoQty} = payload;
        res = await sb.from('log_entries').insert(payloadNoQty).select().single();
      }
      if(res.error) throw res.error;
      logEntries.unshift(res.data);
      await sb.from('cards').update({records:c.records}).eq('id',c.id);
    } catch(e){ toast('‚ö† Errore salvataggio: '+e.message); }
  }
  updateFooter();
}

function stopAllTimers(){ cards.forEach(c=>{c.running=false;c.start=null;c.elapsed=0;}); if(rafId){cancelAnimationFrame(rafId);rafId=null;} }
function startTick(){ if(rafId)return; rafId=requestAnimationFrame(tick); }
function tick(){
  const now=Date.now(); let any=false,maxEl=0;
  cards.forEach(function(c){
    if(!c.running)return; any=true; c.elapsed=now-c.start;
    if(c.elapsed>maxEl)maxEl=c.elapsed;
    const el=document.getElementById('t_'+c.id); if(el)el.textContent=fmt(c.elapsed);
  });
  document.getElementById('fMax').textContent=fmt(maxEl);
  document.getElementById('fActive').textContent=cards.filter(c=>c.running).length;
  if(any){rafId=requestAnimationFrame(tick);}else{rafId=null;}
}
function updateFooter(){
  document.getElementById('fTotal').textContent=cards.length;
  document.getElementById('fRec').textContent=logEntries.length;
  document.getElementById('fActive').textContent=cards.filter(c=>c.running).length;
}

/* ‚îÄ‚îÄ QUANTIT√Ä ‚îÄ‚îÄ */
let qtyCardId = null;
function openQty(id){
  const c = cards.find(x=>x.id===id); if(!c) return;
  qtyCardId = id;
  qtyEditEntryId = null; // assicura modalit√† "card"
  document.getElementById('qtyCardName').textContent = c.name;
  document.getElementById('qtyInput').value = c.qty||1;
  showSheet('qtyOverlay');
  setTimeout(()=>{ const inp=document.getElementById('qtyInput'); inp?.focus(); inp?.select(); },150);
}
function changeQty(delta){
  const inp=document.getElementById('qtyInput');
  inp.value=Math.max(1,Math.min(9999,(parseInt(inp.value)||1)+delta));
}

/* ‚îÄ‚îÄ QUANTIT√Ä OVERLAY ‚îÄ‚îÄ */
let savedQty = 1;
let qtyEditEntryId = null;

// Dispatcher unico: decide se stiamo registrando un nuovo timer o modificando storico
function dispatchQtyConfirm(){
  if(qtyEditEntryId) confirmQtyEdit();
  else confirmQty();
}

function confirmQty(){
  if(qtyCardId){
    const v=Math.max(1,Math.min(9999,parseInt(document.getElementById('qtyInput').value)||1));
    const c=cards.find(x=>x.id===qtyCardId); if(c){ c.qty=v; const el=document.getElementById('q_'+qtyCardId); if(el)el.textContent='√ó'+v; }
    savedQty=v;
    toast('Quantit√†: √ó'+v);
    qtyCardId=null;
  }
  closeSheet('qtyOverlay');
}

async function confirmQtyEdit(){
  if(!qtyEditEntryId) return;
  const entryId = qtyEditEntryId;
  const v = Math.max(1, Math.min(9999, parseInt(document.getElementById('qtyInput').value)||1));
  qtyEditEntryId = null;
  closeSheet('qtyOverlay');
  try{
    console.log('[QTY] Updating entry', entryId, 'to quantity', v);
    const res = await sb.from('log_entries')
      .update({quantity: v})
      .eq('id', entryId);
    console.log('[QTY] Update result:', JSON.stringify(res));
    if(res.error) throw res.error;
    // Verifica che l'aggiornamento sia avvenuto
    const {data:check, error:ce} = await sb.from('log_entries').select('id,quantity').eq('id',entryId).single();
    console.log('[QTY] DB check after update:', JSON.stringify(check), 'error:', JSON.stringify(ce));
    // Aggiorna dato locale
    const entry = logEntries.find(e => e.id === entryId);
    if(entry){ entry.quantity = check?.quantity ?? v; console.log('[QTY] Local entry updated to', entry.quantity); }
    renderHistory();
    toast('‚úì Quantit√† salvata: √ó' + (check?.quantity ?? v));
  } catch(e) {
    console.error('[QTY] Error:', e);
    toast('‚ö† ' + e.message);
  }
}

function openQtyCard(cardId){
  const c = cards.find(x => x.id === cardId);
  if(!c || !c.running) return;
  qtyEditEntryId = null;
  document.getElementById('qtyCardName').textContent = c.name;
  document.getElementById('qtyInput').value = savedQty;
  showSheet('qtyOverlay');
  setTimeout(()=>{ const inp=document.getElementById('qtyInput'); inp?.focus(); inp?.select(); }, 150);
}

function openQtyEdit(entryId, row){
  qtyEditEntryId = entryId;
  const qtyBadge = row.querySelector('.rec-qty');
  const current = qtyBadge ? parseInt(qtyBadge.textContent.replace('√ó',''))||1 : 1;
  const nameEl = row.querySelector('.rec-name');
  document.getElementById('qtyCardName').textContent = nameEl?.textContent || 'rilevazione';
  document.getElementById('qtyInput').value = current;
  showSheet('qtyOverlay');
  setTimeout(()=>{ const inp=document.getElementById('qtyInput'); inp?.focus(); inp?.select(); }, 150);
}

// Attacca pulsanti overlay
document.addEventListener('DOMContentLoaded',()=>{
  const confirmBtn = document.getElementById('qtyConfirmBtn');
  const minusBtn   = document.getElementById('qtyMinus');
  const plusBtn    = document.getElementById('qtyPlus');
  const qtyInp     = document.getElementById('qtyInput');

  // Confirm
  confirmBtn?.addEventListener('click', dispatchQtyConfirm);
  confirmBtn?.addEventListener('mousedown', e=>e.preventDefault());
  confirmBtn?.addEventListener('touchstart', e=>e.preventDefault(), {passive:false});
  confirmBtn?.addEventListener('touchend', e=>{ e.preventDefault(); dispatchQtyConfirm(); });

  // Minus
  minusBtn?.addEventListener('click', ()=>changeQty(-1));
  minusBtn?.addEventListener('mousedown', e=>e.preventDefault());
  minusBtn?.addEventListener('touchstart', e=>e.preventDefault(), {passive:false});
  minusBtn?.addEventListener('touchend', e=>{ e.preventDefault(); changeQty(-1); qtyInp?.focus(); });

  // Plus
  plusBtn?.addEventListener('click', ()=>changeQty(1));
  plusBtn?.addEventListener('mousedown', e=>e.preventDefault());
  plusBtn?.addEventListener('touchstart', e=>e.preventDefault(), {passive:false});
  plusBtn?.addEventListener('touchend', e=>{ e.preventDefault(); changeQty(1); qtyInp?.focus(); });

  // Enter su input
  qtyInp?.addEventListener('keydown', e=>{ if(e.key==='Enter') dispatchQtyConfirm(); });

  // Chiusura overlay (tap fuori o Annulla) ‚Üí reset
  document.getElementById('qtyOverlay')?.addEventListener('click', e=>{
    if(e.target.id==='qtyOverlay') qtyEditEntryId = null;
  });
  document.querySelector('#qtyOverlay .sheet-cancel')?.addEventListener('click', ()=>{
    qtyEditEntryId = null;
  });
});


/* ‚îÄ‚îÄ MEMBERS SCREEN ‚îÄ‚îÄ */
async function openMembersScreen(proj){
  document.getElementById('membersProjLabel').textContent = proj.name;
  document.getElementById('membersScreen').classList.add('show');
  await loadMembers(proj.id);
}

function closeMembersScreen(){
  document.getElementById('membersScreen').classList.remove('show');
}

async function loadMembers(projectId){
  const body = document.getElementById('membersBody');
  body.innerHTML = '<div style="color:var(--dim);font-family:Share Tech Mono,monospace;font-size:11px;padding:20px;">CARICAMENTO...</div>';
  try{
    // Carica membri attuali
    const {data:membersRaw, error:me} = await sb.from('project_members')
      .select('user_id').eq('project_id',projectId);
    if(me) throw me;

    // Carica tutti gli utenti attivi
    const {data:allUsers, error:ue} = await sb.from('profiles')
      .select('id,name').eq('active',true).eq('hidden',false).order('name');
    if(ue) throw ue;

    const memberIds = (membersRaw||[]).map(m=>m.user_id);
    const userMap = {}; (allUsers||[]).forEach(u=>userMap[u.id]=u.name);
    // Build members with names
    const members = (membersRaw||[]).map(m=>({user_id:m.user_id, name:userMap[m.user_id]||'‚Äî'}));
    const available = (allUsers||[]).filter(u=>!memberIds.includes(u.id));

    let html = '';

    // Lista membri attuali
    html += '<div class="members-section-title">RISORSE ASSEGNATE</div>';
    if(!members||!members.length){
      html += '<div style="color:var(--dim);font-family:Share Tech Mono,monospace;font-size:11px;padding:8px 0;">Nessuna risorsa assegnata</div>';
    } else {
      members.forEach(m=>{
        html += '<div class="member-chip">'+
          '<span class="member-chip-name">'+esc(m.name)+'</span>'+
          '<span class="member-chip-remove" data-uid="'+m.user_id+'" data-pid="'+projectId+'">‚úï</span>'+
          '</div>';
      });
    }

    // Aggiungi nuova risorsa
    if(available.length){
      html += '<div class="members-section-title">AGGIUNGI RISORSA</div>';
      html += '<div class="member-add-row">'+
        '<select class="member-add-select" id="memberAddSelect_'+projectId+'">'+
          available.map(u=>'<option value="'+u.id+'">'+esc(u.name)+'</option>').join('')+
        '</select>'+
        '<button class="member-add-btn" data-pid="'+projectId+'">Ôºã AGGIUNGI</button>'+
        '</div>';
    }

    body.innerHTML = html;

    // Event listeners rimozione
    body.querySelectorAll('.member-chip-remove').forEach(btn=>{
      btn.addEventListener('click', async()=>{
        try{
          const {error}=await sb.from('project_members').delete()
            .eq('project_id',btn.dataset.pid).eq('user_id',btn.dataset.uid);
          if(error) throw error;
          await loadMembers(btn.dataset.pid);
          toast('Risorsa rimossa');
        }catch(e){toast('‚ö† '+e.message);}
      });
    });

    // Event listener aggiunta
    const addBtn = body.querySelector('.member-add-btn');
    if(addBtn){
      addBtn.addEventListener('click', async()=>{
        const sel = document.getElementById('memberAddSelect_'+addBtn.dataset.pid);
        if(!sel||!sel.value) return;
        try{
          const {error}=await sb.from('project_members').insert(
            {project_id:addBtn.dataset.pid, user_id:sel.value}
          );
          if(error) throw error;
          await loadMembers(addBtn.dataset.pid);
          toast('Risorsa aggiunta');
        }catch(e){toast('‚ö† '+e.message);}
      });
    }

  }catch(e){
    body.innerHTML='<div style="color:var(--red);font-family:Share Tech Mono,monospace;font-size:11px;padding:20px;">'+esc(e.message)+'</div>';
  }
}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
function goHome(){
  stopAllTimers();
  stopRealtimeSync();
  closeAllSheets();
  currentProject=null;
  currentContract=null;
  currentProcess=null;
  cards=[]; logEntries=[];
  renderAll();
  document.getElementById('projSelectorName').textContent='‚Äî';
  document.getElementById('procIndicator').style.display='none';
  loadContracts();
}

/* ‚îÄ‚îÄ SORT MODE ‚îÄ‚îÄ */
function toggleSort(){
  sortMode=!sortMode; document.body.classList.toggle('sort-mode',sortMode);
  document.getElementById('sortBanner').classList.toggle('show',sortMode);
  const btn=document.getElementById('btnSort');
  if(sortMode){btn.textContent='‚úì';btn.classList.add('sort-active');}
  else{btn.textContent='‚†ø';btn.classList.remove('sort-active');}
  renderAll();
}

/* ‚îÄ‚îÄ TASTI OPZIONI ‚îÄ‚îÄ */
function openRename(){
  const name=cards.find(c=>c.id===ctxId)?.name||''; const sid=ctxId;
  closeSheet('ctxOverlay');
  setTimeout(function(){ctxId=sid;document.getElementById('renameInput').value=name;showSheet('renameOverlay');document.getElementById('renameInput').focus();},120);
}
async function doRename(){
  const v=document.getElementById('renameInput').value.trim(); if(!v){document.getElementById('renameInput').focus();return;}
  try {
    const {error}=await sb.from('cards').update({name:v}).eq('id',ctxId); if(error)throw error;
    const c=cards.find(x=>x.id===ctxId); if(c){c.name=v;}
    const el=document.querySelector('.card[data-id="'+ctxId+'"] .card-name'); if(el)el.textContent=v;
    closeSheet('renameOverlay'); ctxId=null; toast('Rinominato');
  } catch(e){toast('Errore: '+e.message);}
}
document.getElementById('renameInput').addEventListener('keydown',e=>{if(e.key==='Enter')doRename();});
function openSortFromCtx(){ closeSheet('ctxOverlay'); if(!sortMode)toggleSort(); }
async function doDelete(){
  const id=ctxId; closeSheet('ctxOverlay');
  try {
    const {error}=await sb.from('cards').delete().eq('id',id); if(error)throw error;
    const idx=cards.findIndex(c=>c.id===id); if(idx>=0){cards[idx].running=false;cards.splice(idx,1);}
    renderAll(); toast('Tasto eliminato');
  } catch(e){toast('Errore: '+e.message);}
}
function openAdd(){ document.getElementById('addInput').value=''; showSheet('addOverlay'); setTimeout(()=>document.getElementById('addInput').focus(),120); }
async function doAdd(){
  const v=document.getElementById('addInput').value.trim()||'Tasto '+(cards.length+1);
  const pos=cards.length;
  try {
    const {data,error}=await sb.from('cards').insert({project_id:currentProject.id,name:v,position:pos}).select().single(); if(error)throw error;
    cards.push({...data,running:false,start:null,elapsed:0}); renderAll(); closeSheet('addOverlay'); toast('"'+v+'" aggiunto');
  } catch(e){toast('Errore: '+e.message);}
}
document.getElementById('addInput').addEventListener('keydown',e=>{if(e.key==='Enter')doAdd();});

/* ‚îÄ‚îÄ GESTIONE PROGETTI ‚îÄ‚îÄ */
async function openProjSheet(){
  const {data:projects}=await sb.from('projects').select('id,name,created_at').order('created_at',{ascending:false});
  renderProjSheet(projects||[]);
  showSheet('projOverlay');
}
function renderProjSheet(projects){
  const wrap=document.getElementById('projSheetList'); wrap.innerHTML='';
  if(!projects.length){wrap.innerHTML='<div style="color:var(--dim);font-size:12px;font-family:\'Share Tech Mono\',monospace;padding:8px 0 12px;text-align:center;">Nessun progetto</div>';return;}
  projects.forEach(p=>{
    const isCur=currentProject&&p.id===currentProject.id;
    const item=document.createElement('div'); item.className='proj-sheet-item'+(isCur?' active-proj':'');
    item.innerHTML=
      (isCur?'<div class="proj-sheet-badge">ATTIVO</div>':'')+
      '<div class="proj-sheet-body">'+
        '<div class="proj-sheet-name'+(isCur?' active-name':'')+'">'+esc(p.name)+'</div>'+
        '<div class="proj-sheet-meta">'+dateStr(p.created_at)+'</div>'+
      '</div>'+
      (currentUser.role==='admin'?'<div class="proj-sheet-del">‚úï</div>':'');
    item.querySelector('.proj-sheet-body').addEventListener('click',()=>{
      if(isCur){renameProjId=p.id;document.getElementById('renameProjInput').value=p.name;closeSheet('projOverlay');setTimeout(()=>{showSheet('renameProjOverlay');document.getElementById('renameProjInput').focus();},120);}
      else{closeAllSheets();setTimeout(()=>selectProject(p),80);}
    });
    if(currentUser.role==='admin') item.querySelector('.proj-sheet-del').addEventListener('click',e=>{e.stopPropagation();deleteProjConfirm(p.id,p.name);});
    wrap.appendChild(item);
  });
  const note=document.createElement('div'); note.style.cssText='font-size:10px;color:var(--dim);font-family:\'Share Tech Mono\',monospace;text-align:center;padding:4px 0 8px;';
  note.textContent='tap sul progetto attivo per rinominarlo'; wrap.appendChild(note);
}
async function openNewProjSheet(){
  document.getElementById('newProjInput').value='';
  document.getElementById('newProjPreview').textContent='‚Äî';

  // Popola i selettori data con oggi come default
  const today = new Date();
  const dayEl = document.getElementById('newProjDay');
  const monEl = document.getElementById('newProjMonth');
  const yrEl  = document.getElementById('newProjYear');

  dayEl.innerHTML = Array.from({length:31},(_,i)=>{
    const v=String(i+1).padStart(2,'0');
    return '<option value="'+v+'"'+(i+1===today.getDate()?' selected':'')+'>'+v+'</option>';
  }).join('');

  const months=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno',
                 'Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  monEl.innerHTML = months.map((m,i)=>{
    const v=String(i+1).padStart(2,'0');
    return '<option value="'+v+'"'+(i===today.getMonth()?' selected':'')+'>'+m+'</option>';
  }).join('');

  const thisYear = today.getFullYear();
  yrEl.innerHTML = [thisYear-1,thisYear,thisYear+1].map(y=>
    '<option value="'+y+'"'+(y===thisYear?' selected':'')+'>'+y+'</option>'
  ).join('');

  // Aggiorna preview nome
  const updatePreview = ()=>{
    const name = document.getElementById('newProjInput').value.trim();
    const d=dayEl.value, m=monEl.value, y=yrEl.value;
    document.getElementById('newProjPreview').textContent = name ? y+m+d+'_'+name : '‚Äî';
  };
  dayEl.onchange = monEl.onchange = yrEl.onchange = updatePreview;
  document.getElementById('newProjInput').oninput = updatePreview;

  // Popola reparti filtrati per magazzino dell'appalto corrente
  const repartoSel = document.getElementById('newProjReparto');
  repartoSel.innerHTML = '<option value="">‚Äî nessuno ‚Äî</option>';
  if(currentContract?.magazzino_id){
    const {data:reparti} = await sb.from('reparti').select('id,name').eq('magazzino_id',currentContract.magazzino_id).order('name');
    (reparti||[]).forEach(r=>{
      const o=document.createElement('option'); o.value=r.id; o.textContent=r.name;
      repartoSel.appendChild(o);
    });
  }
  // Reset inline form
  document.getElementById('newRepartoInline').style.display='none';
  document.getElementById('newRepartoInput').value='';

  // Popola responsabili
  const sel = document.getElementById('newProjResponsible');
  sel.innerHTML = '<option value="">‚Äî caricamento ‚Äî</option>';
  const {data:users} = await sb.from('profiles').select('id,name').eq('active',true).eq('hidden',false).order('name');
  sel.innerHTML = (users||[]).map(u=>
    '<option value="'+u.id+'"'+(u.id===currentUser.id?' selected':'')+'>'+esc(u.name)+'</option>'
  ).join('');

  showSheet('newProjOverlay');
  setTimeout(()=>document.getElementById('newProjInput').focus(),120);
}
function toggleNewRepartoInline(){
  const wrap = document.getElementById('newRepartoInline');
  const show = wrap.style.display==='none';
  wrap.style.display = show ? 'block' : 'none';
  if(show) setTimeout(()=>document.getElementById('newRepartoInput')?.focus(), 80);
}
function cancelNewRepartoInline(){
  document.getElementById('newRepartoInline').style.display='none';
  document.getElementById('newRepartoInput').value='';
}
async function saveNewRepartoInline(){
  const name=(document.getElementById('newRepartoInput')?.value||'').trim().toUpperCase();
  if(!name){ document.getElementById('newRepartoInput')?.focus(); return; }
  const magazzinoId = currentContract?.magazzino_id || null;
  try{
    const {data,error}=await sb.from('reparti').insert({name,magazzino_id:magazzinoId}).select().single();
    if(error) throw error;
    // Aggiungi al select e seleziona
    const sel=document.getElementById('newProjReparto');
    const opt=document.createElement('option'); opt.value=data.id; opt.textContent=data.name;
    sel.appendChild(opt); sel.value=data.id;
    cancelNewRepartoInline();
    toast('‚úì Reparto "'+name+'" creato');
  }catch(e){ toast(e.message.includes('unique')||e.message.includes('duplicate')?'Reparto gi√† esistente':'‚ö† '+e.message); }
}

async function doCreateProject(){
  const rawName=document.getElementById('newProjInput').value.trim(); if(!rawName){document.getElementById('newProjInput').focus();return;}
  const d=document.getElementById('newProjDay')?.value||'';
  const m=document.getElementById('newProjMonth')?.value||'';
  const y=document.getElementById('newProjYear')?.value||'';
  const name = (y&&m&&d) ? y+m+d+'_'+rawName : rawName;
  try {
    const responsibleId = document.getElementById('newProjResponsible')?.value || currentUser.id;
    const repartoId = document.getElementById('newProjReparto')?.value || null;
    const {data,error}=await sb.from('projects').insert({name,created_by:currentUser.id,responsible_id:responsibleId,contract_id:currentContract?.id||null,reparto_id:repartoId||null}).select().single();
    if(error)throw error;
    const defaults=['01','02','03','04','05','06','07','08','09','10'];
    await sb.from('cards').insert(defaults.map((n,i)=>({project_id:data.id,name:n,position:i})));
    // Aggiunge automaticamente il creatore come membro
    await sb.from('project_members').insert({project_id:data.id, user_id:currentUser.id});
    closeAllSheets(); if(currentContract)await selectContract(currentContract);else await loadContracts(); toast('Progetto "'+name+'" creato');
  } catch(e){
    const inp=document.getElementById('newProjInput'); inp.style.borderColor='var(--red)';
    toast('‚ö† '+e.message); setTimeout(()=>inp.style.borderColor='',2000);
  }
}
document.getElementById('newProjInput').addEventListener('keydown',e=>{if(e.key==='Enter')doCreateProject();});
async function doRenameProj(){
  const name=document.getElementById('renameProjInput').value.trim(); if(!name){document.getElementById('renameProjInput').focus();return;}
  try {
    const {error}=await sb.from('projects').update({name}).eq('id',renameProjId); if(error)throw error;
    if(currentProject?.id===renameProjId){currentProject.name=name;document.getElementById('projSelectorName').textContent=name;}
    closeSheet('renameProjOverlay'); toast('Progetto rinominato');
  } catch(e){
    const inp=document.getElementById('renameProjInput'); inp.style.borderColor='var(--red)';
    toast('‚ö† '+e.message); setTimeout(()=>inp.style.borderColor='',2000);
  }
}
document.getElementById('renameProjInput').addEventListener('keydown',e=>{if(e.key==='Enter')doRenameProj();});
async function deleteProjConfirm(id,name){
  if(!confirm('Eliminare il progetto "'+name+'" e tutti i dati?'))return;
  try {
    const {error}=await sb.from('projects').delete().eq('id',id); if(error)throw error;
    if(currentProject?.id===id){currentProject=null;stopAllTimers();cards=[];logEntries=[];renderAll();document.getElementById('projSelectorName').textContent='‚Äî';document.getElementById('splash').classList.remove('hidden');}
    if(currentContract)await selectContract(currentContract);else await loadContracts(); toast('Progetto eliminato');
  } catch(e){toast('Errore: '+e.message);}
}

/* ‚îÄ‚îÄ STORICO ‚îÄ‚îÄ */
let showAllUsers = false;

function toggleAllUsers(){
  showAllUsers = !showAllUsers;
  const btn = document.getElementById('btnAllUsers');
  if(showAllUsers){
    btn.textContent = 'üë• TUTTI';
    btn.style.borderColor = 'var(--purple)';
    btn.style.color = 'var(--purple)';
  } else {
    btn.textContent = 'üë§ IO';
    btn.style.borderColor = 'var(--orange)';
    btn.style.color = 'var(--orange)';
  }
  renderHistory();
}

async function openHistory(){
  document.getElementById('histProjLabel').textContent=currentProject?.name||'';
  document.getElementById('clearBtn').style.display=(currentUser?.role==='admin'||currentUser?.role==='project_manager')?'':'none';
  // Reset a "solo mie" ogni volta che si apre
  showAllUsers = false;
  const btn = document.getElementById('btnAllUsers');
  btn.textContent='üë§ IO'; btn.style.borderColor='var(--orange)'; btn.style.color='var(--orange)';
  await loadLog();
  const sel=document.getElementById('filterSelect');
  sel.innerHTML='<option value="">Tutti i tasti</option>';
  [...new Set(logEntries.map(r=>r.card_name))].sort().forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;sel.appendChild(o);});
  renderHistory();
  document.getElementById('histScreen').classList.add('show');
}
function closeHistory(){ document.getElementById('histScreen').classList.remove('show'); }
function getFilteredLog(){
  const f=document.getElementById('filterSelect').value;
  let entries = showAllUsers ? [...logEntries] : logEntries.filter(r=>r.user_id===currentUser.id);
  if(f) entries = entries.filter(r=>r.card_name===f);
  return entries;
}
function attachSwipeDelete(wrap, row, delBg, entry){
  const entryId = typeof entry === 'object' ? entry.id : entry;
  const DEL_W = 110;   // swipe sinistra ‚Üí elimina
  const REN_W = 120;   // swipe destra ‚Üí riassegna

  // Aggiungi sfondo destra (riassegna)
  const renBg = document.createElement('div'); renBg.className='rec-ren-bg';
  renBg.innerHTML='<span>RIASSEGNA</span>';
  wrap.appendChild(renBg);

  let px=0, py=0, active=false, dir=null, swipedLeft=false, swipedRight=false;
  let lpTimer=null, lpFired=false;

  wrap.addEventListener('pointerdown', e=>{
    px=e.clientX; py=e.clientY; active=true; dir=null; lpFired=false;
    wrap.setPointerCapture(e.pointerId);
    row.style.transition='none';
    delBg.style.transition='none';
    renBg.style.transition='none';
    lpTimer=setTimeout(()=>{
      lpFired=true;
      if(active && dir!=='h'){ vib(40); openQtyEdit(entryId, row); }
    },600);
  });

  wrap.addEventListener('pointermove', e=>{
    if(!active) return;
    const dx=e.clientX-px, dy=e.clientY-py;
    if(Math.abs(dx)>8||Math.abs(dy)>8){ if(lpTimer){clearTimeout(lpTimer);lpTimer=null;} }
    if(dir===null){
      if(Math.abs(dx)<6 && Math.abs(dy)<6) return;
      dir = Math.abs(dx)>Math.abs(dy) ? 'h' : 'v';
    }
    if(dir==='v') return;
    e.preventDefault();
    if(dx < 0){
      // Swipe sinistra ‚Üí elimina
      let shift = swipedLeft
        ? Math.max(0, Math.min(DEL_W + (-dx - DEL_W), DEL_W))
        : Math.max(0, Math.min(-dx, DEL_W));
      if(dx>0 && swipedLeft) shift = Math.max(0, DEL_W - Math.abs(dx));
      row.style.transform='translateX(-'+shift+'px)';
      delBg.style.opacity=String((shift/DEL_W).toFixed(2));
      renBg.style.opacity='0';
    } else {
      // Swipe destra ‚Üí riassegna
      let shift = swipedRight
        ? Math.max(0, Math.min(REN_W, REN_W - (dx - REN_W)))
        : Math.max(0, Math.min(dx, REN_W));
      row.style.transform='translateX('+shift+'px)';
      renBg.style.opacity=String((shift/REN_W).toFixed(2));
      delBg.style.opacity='0';
    }
  });

  wrap.addEventListener('pointerup', e=>{
    if(lpTimer){clearTimeout(lpTimer);lpTimer=null;}
    if(!active) return; active=false;
    if(lpFired) return;
    if(dir!=='h') return;
    const dx=e.clientX-px;
    row.style.transition='transform .25s ease';
    delBg.style.transition='opacity .25s ease';
    renBg.style.transition='opacity .25s ease';

    if(dx < -(DEL_W*0.45) && !swipedLeft){
      // Snap aperto a sinistra
      swipedLeft=true; swipedRight=false;
      row.style.transform='translateX(-'+DEL_W+'px)';
      delBg.style.opacity='1'; delBg.classList.add('show');
      renBg.style.opacity='0'; renBg.classList.remove('show');
      row.classList.add('swiped-left'); row.classList.remove('swiped-right');
    } else if(dx > (REN_W*0.45) && !swipedRight){
      // Snap aperto a destra ‚Üí apri overlay riassegna
      swipedRight=false; // chiudi subito
      row.style.transform='';
      renBg.style.opacity='0'; renBg.classList.remove('show');
      row.classList.remove('swiped-right');
      openRenameActivity(entryId, row);
    } else {
      // Chiudi entrambi
      swipedLeft=false; swipedRight=false;
      row.style.transform='';
      delBg.style.opacity='0'; delBg.classList.remove('show');
      renBg.style.opacity='0'; renBg.classList.remove('show');
      row.classList.remove('swiped-left','swiped-right');
    }
  });

  wrap.addEventListener('pointercancel', ()=>{
    if(lpTimer){clearTimeout(lpTimer);lpTimer=null;}
    active=false;
    row.style.transition='transform .25s ease';
    row.style.transform='';
    delBg.style.opacity='0'; delBg.classList.remove('show');
    renBg.style.opacity='0'; renBg.classList.remove('show');
    swipedLeft=false; swipedRight=false;
    row.classList.remove('swiped-left','swiped-right');
  });

  document.addEventListener('pointerdown', e=>{
    if((swipedLeft||swipedRight) && !wrap.contains(e.target)){
      swipedLeft=false; swipedRight=false;
      row.style.transition='transform .2s ease';
      row.style.transform='';
      delBg.style.opacity='0'; delBg.classList.remove('show');
      renBg.style.opacity='0'; renBg.classList.remove('show');
      row.classList.remove('swiped-left','swiped-right');
    }
  });

  delBg.querySelector('span').addEventListener('click', async e=>{
    e.stopPropagation();
    try{
      const {error}=await sb.from('log_entries').delete().eq('id',entryId);
      if(error) throw error;
      wrap.style.transition='opacity .25s';
      wrap.style.opacity='0';
      setTimeout(async()=>{ wrap.remove(); await loadLog(); renderHistory(); },260);
      toast('Rilevazione eliminata');
    }catch(err){ toast('‚ö† '+err.message); }
  });

  renBg.querySelector('span').addEventListener('click', e=>{
    e.stopPropagation();
    row.style.transform='';
    renBg.style.opacity='0'; renBg.classList.remove('show');
    swipedRight=false;
    openRenameActivity(entryId, row);
  });
}

function renderHistory(){
  const body=document.getElementById('histBody'),filtered=getFilteredLog(),tot=filtered.length;
  document.getElementById('hsTot').textContent=tot;
  if(!tot){['hsMedia','hsMin','hsMax'].forEach(id=>document.getElementById(id).textContent='‚Äî');body.innerHTML='<div class="hist-empty">Nessuna rilevazione.</div>';return;}
  const durs=filtered.map(r=>r.duration_ms);
  document.getElementById('hsMedia').textContent=fmtS(durs.reduce((a,b)=>a+b,0)/tot);
  document.getElementById('hsMin').textContent=fmtS(Math.min(...durs));
  document.getElementById('hsMax').textContent=fmtS(Math.max(...durs));
  const byDay={};
  filtered.forEach(r=>{const day=dateStr(r.started_at);if(!byDay[day])byDay[day]=[];byDay[day].push(r);});
  body.innerHTML='';
  Object.keys(byDay).forEach(day=>{
    const grp=document.createElement('div'); grp.className='day-group';
    const lbl=document.createElement('div'); lbl.className='day-label';
    lbl.textContent=day+' ‚Äî '+byDay[day].length+' rilevazioni'; grp.appendChild(lbl);
    byDay[day].forEach(r=>{
      const wrap=document.createElement('div'); wrap.className='rec-wrap';
      const delBg=document.createElement('div'); delBg.className='rec-del-bg';
      delBg.innerHTML='<span>ELIMINA</span>';
      const row=document.createElement('div'); row.className='rec-row';
      row.innerHTML='<div class="rec-name">'+esc(r.card_name)+'</div>'+
        '<div class="rec-info"><div class="rec-time">'+timeStr(r.started_at)+' ‚Üí '+timeStr(r.ended_at)+'</div>'+
        '<div class="rec-user">'+esc(r.user_name||'')+'</div></div>'+
        '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;">'+
          '<div class="rec-dur">'+fmtS(r.duration_ms)+'</div>'+
          ((r.quantity&&r.quantity>1)?'<div class="rec-qty">√ó'+r.quantity+'</div>':'')+
        '</div>';
      attachSwipeDelete(wrap, row, delBg, r);
      wrap.appendChild(delBg);
      wrap.appendChild(row);
      grp.appendChild(wrap);
    });
    body.appendChild(grp);
  });
}
async function confirmClear(){
  const f=document.getElementById('filterSelect').value;
  if(!confirm(f?'Svuotare le rilevazioni di "'+f+'"?':'Svuotare tutto lo storico del progetto?'))return;
  try {
    let q=sb.from('log_entries').delete().eq('project_id',currentProject.id);
    if(f) q=q.eq('card_name',f);
    const {error}=await q; if(error)throw error;
    if(!f){ await sb.from('cards').update({records:0}).eq('project_id',currentProject.id); cards.forEach(c=>c.records=0); }
    else { const c=cards.find(x=>x.name===f); if(c){await sb.from('cards').update({records:0}).eq('id',c.id);c.records=0;} }
    renderAll(); await loadLog(); openHistory(); toast('Storico svuotato');
  } catch(e){toast('Errore: '+e.message);}
}

/* ‚îÄ‚îÄ EXPORT EXCEL ‚îÄ‚îÄ */
function openExport(){ document.getElementById('emailInput').value=''; showSheet('exportOverlay'); setTimeout(()=>document.getElementById('emailInput').focus(),120); }
async function doExport(){
  const filtered=getFilteredLog(); if(!filtered.length){toast('Nessuna rilevazione');return;}
  const sorted=[...filtered].sort((a,b)=>new Date(a.started_at)-new Date(b.started_at));
  const wsData=[['N¬∞','Progetto','Tasto','Operatore','Data','Ora Inizio','Ora Fine','Durata (mm:ss.ms)','Durata (sec,ms)','Durata (ms)','Qt√†']];
  sorted.forEach((r,i)=>{
    const si=Math.floor(r.duration_ms/1000),ms=String(r.duration_ms%1000).padStart(3,'0');
    wsData.push([i+1,currentProject?.name||'‚Äî',r.card_name,r.user_name||'‚Äî',dateStr(r.started_at),timeStr(r.started_at),timeStr(r.ended_at),fmt(r.duration_ms),si+','+ms,r.duration_ms,r.quantity||1]);
  });
  const names=[...new Set(sorted.map(r=>r.card_name))];
  const summData=[['Tasto','N¬∞ Rilevazioni','Qt√† Totale','Durata Totale','Media','Min','Max']];
  names.forEach(n=>{
    const recs=sorted.filter(r=>r.card_name===n),durs=recs.map(r=>r.duration_ms),tot=durs.reduce((a,b)=>a+b,0);
    const qtyTot=recs.reduce((a,r)=>a+(r.quantity||1),0);
    summData.push([n,recs.length,qtyTot,fmtS(tot),fmtS(tot/recs.length),fmtS(Math.min(...durs)),fmtS(Math.max(...durs))]);
  });
  const wb=XLSX.utils.book_new();
  const ws1=XLSX.utils.aoa_to_sheet(wsData),ws2=XLSX.utils.aoa_to_sheet(summData);
  ws1['!cols']=[{wch:4},{wch:18},{wch:18},{wch:18},{wch:12},{wch:12},{wch:12},{wch:18},{wch:12},{wch:12},{wch:6}];
  ws2['!cols']=[{wch:20},{wch:16},{wch:12},{wch:16},{wch:16},{wch:10},{wch:10}];
  XLSX.utils.book_append_sheet(wb,ws1,'Rilevazioni'); XLSX.utils.book_append_sheet(wb,ws2,'Riepilogo');
  const now=new Date();
  const fname='rilevazioni_'+(currentProject?.name||'export').replace(/[^a-zA-Z0-9_\-]/g,'_')+'_'+now.getFullYear()+p2(now.getMonth()+1)+p2(now.getDate())+'.xlsx';
  const wbArr=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  const blob=new Blob([wbArr],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const file=new File([blob],fname,{type:blob.type});
  closeSheet('exportOverlay');
  if(navigator.canShare&&navigator.canShare({files:[file]})){
    try{await navigator.share({title:'Rilevazioni',files:[file]});toast('‚úì Condiviso');return;}
    catch(err){if(err.name==='AbortError'){toast('Annullato');return;}}
  }
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); document.body.removeChild(a); setTimeout(()=>URL.revokeObjectURL(url),3000);
  toast('‚úì Excel scaricato');
  const email=document.getElementById('emailInput').value.trim();
  if(email){setTimeout(()=>{const s=encodeURIComponent('Rilevazioni ‚Äî '+currentProject?.name);const b=encodeURIComponent('Ciao,\n\nallego "'+fname+'".\n\n(Allega il file scaricato)');window.location.href='mailto:'+encodeURIComponent(email)+'?subject='+s+'&body='+b;},600);}
}

/* ‚îÄ‚îÄ SHEET HELPERS ‚îÄ‚îÄ */
function showSheet(id){ document.getElementById(id).classList.add('show'); }
function closeSheet(id){
  document.getElementById(id).classList.remove('show');
  if(id==='qtyOverlay') document.getElementById('qtyInput')?.blur();
}
function closeAllSheets(){
  ['ctxOverlay','renameOverlay','addOverlay','exportOverlay','projOverlay','newProjOverlay','renameProjOverlay','newContractOverlay','qtyOverlay','renameActivityOverlay']
  .forEach(id=>document.getElementById(id).classList.remove('show'));
}
['ctxOverlay','renameOverlay','addOverlay','exportOverlay','projOverlay','newProjOverlay','renameProjOverlay','newContractOverlay','qtyOverlay','renameActivityOverlay']
.forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('click',e=>{if(e.target.id===id)closeSheet(id);}); });

/* ‚îÄ‚îÄ TOAST / LOADING ‚îÄ‚îÄ */
let toastT=null;
function toast(msg){
  const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show');
  clearTimeout(toastT); toastT=setTimeout(()=>el.classList.remove('show'),2400);
}
function showLoading(txt=''){
  document.getElementById('loadingText').textContent=txt||'CARICAMENTO...';
  document.getElementById('loadingScreen').classList.remove('hidden');
}
function hideLoading(){ document.getElementById('loadingScreen').classList.add('hidden'); }

/* ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ */
function showLogin(){
  hideLoading();
  document.getElementById('loginScreen').classList.remove('hidden');
}

(async function boot(){
  showLoading('CONNESSIONE...');

  // Timeout globale: se dopo 10s non siamo usciti dal boot, mostra login
  const safetyTimer = setTimeout(()=>{ console.warn('Boot timeout'); showLogin(); requestWakeLock(); }, 10000);

  try {
    // getSession con timeout 5s per evitare hang da LockManager (es. dopo admin panel)
    const sessionResult = await Promise.race([
      sb.auth.getSession(),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('getSession timeout')),5000))
    ]);
    const { data: { session }, error } = sessionResult;
    if(error) throw error;

    if(session){
      const {data:prof, error:pe}=await sb.from('profiles').select('name,role,active').eq('id',session.user.id).single();
      if(pe) throw pe;
      if(prof?.active){
        currentUser={id:session.user.id,email:session.user.email,name:prof.name,role:prof.role};
        clearTimeout(safetyTimer);
        await requestWakeLock();
        await tryAutoFullscreen();
        hideLoading(); afterLogin(); return;
      }
    }
  } catch(e){ console.error('Boot error:', e.message); }

  clearTimeout(safetyTimer);
  showLogin();
  requestWakeLock();
})();
</script>
</body>
</html>
